(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const s of d.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function a(o){if(o.ep)return;o.ep=!0;const d=n(o);fetch(o.href,d)}})();const f={ProgramAdded:"program_added",ProgramDeleted:"program_deleted",ProgramStarted:"program_started",ProgramCompleted:"program_completed",SeriesStarted:"series_started",SeriesCompleted:"series_completed",SeriesStopped:"series_stopped",SeriesNext:"series_next",EventStarted:"event_started",TargetStatus:"target_status",AudioAdded:"audio_added",AudioDeleted:"audio_deleted",Chrono:"chrono",AdminModeStatus:"admin_mode_status",BackendIssue:"backend_issue"};let L=null;function N(e){return L&&L.close(),L=new EventSource(j,{withCredentials:!1}),Object.values(f).forEach(t=>{L.addEventListener(t,n=>{try{const a=JSON.parse(n.data);console.log("Received SSE event:",t,a),e(t,a)}catch(a){console.error("Failed to parse event:",t,a)}})}),L.onopen=()=>{console.log("SSE connection established")},L.onerror=t=>{console.error("SSE connection error:",t)},L}const W=()=>localStorage.getItem("SERVER_BASE_URL")||"http://localhost:8080";let b=W(),g=`${b}/api/v1`,j=`${b}/sse/v1`,B=localStorage.getItem("ADMIN_BEARER_TOKEN")||null;function X(e){b=e,g=`${b}/api/v1`,j=`${b}/sse/v1`,localStorage.setItem("SERVER_BASE_URL",e),typeof N=="function"&&(L&&L.close(),N())}function q(){const e=document.getElementById("settings-form"),t=document.getElementById("server-base-url"),n=document.getElementById("settings-status"),a=document.getElementById("admin-enable-form"),o=document.getElementById("admin-disable-form"),d=document.getElementById("admin-password"),s=document.getElementById("admin-mode-status");t.value=b,e.onsubmit=r=>{r.preventDefault();const c=t.value.trim();if(!c||!G(c)){n.textContent="Please enter a valid URL.",n.style.color="red";return}X(c),n.textContent="Server Base URL updated!",n.style.color="green",m()},a.onsubmit=async r=>{r.preventDefault();const c=d.value;s.textContent="";try{B=(await re(c)).token,localStorage.setItem("ADMIN_BEARER_TOKEN",B),d.value="",s.textContent="Admin mode enabled!",s.style.color="green",m()}catch{s.textContent="Failed to enable admin mode.",s.style.color="red"}},o.onsubmit=async r=>{r.preventDefault(),s.textContent="";try{await ce(B),B=null,localStorage.removeItem("ADMIN_BEARER_TOKEN"),s.textContent="Admin mode disabled!",s.style.color="green",m()}catch{s.textContent="Failed to disable admin mode.",s.style.color="red"}};async function m(){try{const{enabled:r}=await ie();r?B?(a.classList.add("hidden"),o.classList.remove("hidden"),s.textContent="Admin mode is enabled.",s.style.color="green"):(a.classList.add("hidden"),o.classList.add("hidden"),s.textContent="Admin mode is enabled (by another client).",s.style.color="orange"):(a.classList.remove("hidden"),o.classList.add("hidden"),s.textContent="Admin mode is disabled.",s.style.color="gray")}catch{s.textContent="Could not fetch admin mode status.",s.style.color="red"}}q.updateAdminModeUI=m,m()}function G(e){try{const t=new URL(e);return/^https?:$/.test(t.protocol)&&(/^[a-zA-Z0-9.-]+$/.test(t.hostname)||/^(\d{1,3}\.){3}\d{1,3}$/.test(t.hostname))?/^(\d{1,3}\.){3}\d{1,3}$/.test(t.hostname)?t.hostname.split(".").every(n=>{const a=Number(n);return a>=0&&a<=255}):!0:!1}catch{return!1}}const v=Object.freeze({GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE",PATCH:"PATCH"});async function J(){const e=await fetch(`${g}/programs`);return h(e)}async function z(e){const t=await fetch(`${g}/programs/${e}`);return h(t)}async function Y(e,t){const n=t?`${g}/programs/${t}/update`:`${g}/programs`,a=t?v.PUT:v.POST,o=await E(n,{method:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return h(o)}async function Z(e){const t=await E(`${g}/programs/${e}/delete`,{method:v.DELETE,headers:{"Content-Type":"application/json"}});return h(t)}async function Q(e){const t=await E(`${g}/programs/${e}/load`,{method:"POST"});return h(t)}async function ee(){const e=await E(`${g}/programs/start`,{method:"POST"});return h(e)}async function te(){const e=await E(`${g}/programs/stop`,{method:"POST"});return h(e)}async function ne(e){const t=await E(`${g}/programs/series/${e}/skip_to`,{method:v.POST,headers:{"Content-Type":"application/json"}});return h(t)}async function oe(){const e=await fetch(`${g}/audios`);return h(e)}async function ae(e,t,n){const a=new FormData;a.append("file",e),a.append("codec",t),a.append("title",n);const o=await E(`${g}/audios`,{method:v.POST,body:a});return h(o)}async function se(e){const t=await E(`${g}/audios/${e}/delete`,{method:v.DELETE,headers:{"Content-Type":"application/json"}});return h(t)}async function de(){const e=await E(`${g}/targets/toggle`,{method:"POST"});return h(e)}async function ie(){const e=await fetch(`${g}/admin-mode/status`);return h(e)}async function re(e){const t=await fetch(`${g}/admin-mode/enable`,{method:v.POST,headers:{"Content-Type":"application/json"},body:JSON.stringify({password:e})});return h(t)}async function ce(){const e=await E(`${g}/admin-mode/disable`,{method:v.POST});return h(e)}async function h(e){if(!e.ok)throw new Error(`Request failed: ${e.statusText}`);const t=e.headers.get("Content-Type");return t&&t.includes("application/json")?e.json():null}async function E(e,t={}){const n=localStorage.getItem("ADMIN_BEARER_TOKEN");return t.headers=t.headers||{},n&&(t.headers.Authorization=`Bearer ${n}`),await fetch(e,t)}let $=[];async function R(){return $=(await oe()).audios||[],$}function O(e){return $.find(n=>n.id===e).title}const F=Object.freeze({Default:"default",Field:"field"});let U=null;function V(e,t,n=F.Default){n===F.Field?me(e,t):le(e,t)}function le(e,t){e.innerHTML="",U=H(t.series);let n=document.createElement("div");n.className="timeline-tooltip",e.appendChild(n),U.forEach((a,o)=>{const d=document.createElement("div");d.className="series",a.optional&&d.classList.add("optional"),d.dataset.seriesIndex=o;const s=document.createElement("div");s.className="series-title",s.textContent=a.name+(a.optional?" (optional)":""),d.appendChild(s);const m=document.createElement("div");m.className="events",a.events.forEach((r,c)=>{const i=document.createElement("div");i.className=`event ${r.symbolClass}`,i.dataset.eventIndex=c,i.addEventListener("mouseenter",()=>{let y="";r.audio_ids&&r.audio_ids.length>0&&(y="<br>Audios:<br>"+r.audio_ids.map(T=>`"${O(T)}" (${T})`).join("<br>")),n.innerHTML=`<strong>Duration:</strong> ${Math.trunc(r.duration/1e3)}s<br><strong>Command:</strong> ${r.command||"none"}${y}`,n.style.display="block";const S=i.getBoundingClientRect();n.style.left=`${S.left+window.scrollX}px`,n.style.top=`${S.top+window.scrollY-40}px`}),i.addEventListener("mouseleave",()=>{n.style.display="none"});const l=document.createElement("div");l.className="dur",l.textContent=Math.trunc(r.duration/1e3),i.appendChild(l);const u=document.createElement("div");u.className="symbol",u.textContent=r.symbolText,i.appendChild(u);const p=document.createElement("div");if(p.className="acc",p.textContent=Math.trunc(r.acc/1e3),i.appendChild(p),r.audio_ids&&r.audio_ids.length>0){const y=r.audio_ids.map(O).join(", ");i.setAttribute("title",y)}m.appendChild(i)}),d.appendChild(m),e.appendChild(d)})}function me(e,t){e.innerHTML="";let n=document.createElement("div");n.className="logic-timeline-tooltip",e.appendChild(n),H(t.series).forEach((o,d)=>{const s=document.createElement("div");s.className="logic-timeline-container",o.optional&&s.classList.add("optional"),s.dataset.seriesIndex=d;const m=document.createElement("div");m.className="series-title",m.textContent=o.name+(o.optional?" (optional)":""),s.appendChild(m);const r=document.createElement("div");r.className="logic-timeline-centerline";let c=0;o.events.forEach(l=>{const u=Math.max(1,Math.trunc(l.duration/1e3)),p=document.createElement("div");p.className=`logic-segment ${l.command||""}`,p.style.width=`${u*40}px`,p.dataset.duration=l.duration;const y=document.createElement("div");y.className="logic-info-line",y.textContent=`${u}s`,l.audio_ids&&(y.textContent+=" A"),p.appendChild(y),p.addEventListener("mouseenter",S=>{let T="";l.audio_ids&&l.audio_ids.length>0&&(T="<br>Audios:<br>"+l.audio_ids.map(k=>`"${O(k)}" (${k})`).join("<br>")),n.innerHTML=`<strong>Duration:</strong> ${u}s<br><strong>Command:</strong> ${l.command||"none"}${T}`,n.style.display="block";const P=p.getBoundingClientRect();n.style.left=`${P.left+window.scrollX}px`,n.style.top=`${P.top+window.scrollY-40}px`}),p.addEventListener("mouseleave",()=>{n.style.display="none"}),l.command==="show"?p.classList.add("above"):l.command==="hide"&&p.classList.add("on-line"),p.title=`${l.command||""} (${u}s)`,r.appendChild(p),c+=u});const i=document.createElement("div");i.className="logic-timeline-axis",i.style.position="relative",i.style.width=`${c*40}px`;for(let l=0;l<=c;l++){const u=document.createElement("span");u.className="logic-timeline-tick",u.textContent=l,u.id=`logic-tick-${d}-${l}`,u.dataset.seriesIndex=d,u.dataset.second=l,u.style.position="absolute",u.style.left=`${l*40}px`,u.style.transform="translateX(-50%)",i.appendChild(u)}s.appendChild(r),s.appendChild(i),e.appendChild(s)})}function H(e){return e.map(t=>{let n=0;const a=t.events.map(o=>{const d=o.duration;let s="no-action",m="";return o.audio_ids&&o.audio_ids.length>0?(m="A",o.command==="show"?s="show audio":o.command==="hide"?s="hide audio":s="audio"):o.command==="show"?s="show":o.command==="hide"?s="hide":s="no-action",n+=d,{...o,duration:d,acc:n,symbolClass:s,symbolText:m}});return{...t,events:a}})}function I(e,t){document.querySelectorAll(".series").forEach(o=>o.classList.remove("current")),document.querySelectorAll(".event").forEach(o=>o.classList.remove("current")),document.querySelectorAll(".logic-segment").forEach(o=>o.classList.remove("current")),document.querySelectorAll(".logic-timeline-container").forEach(o=>o.classList.remove("current"));const n=document.querySelector(`[data-series-index='${e}']`);if(n){n.classList.add("current");const o=n.querySelector(`[data-event-index='${t}']`);o&&o.classList.add("current")}const a=document.querySelectorAll(".logic-timeline-container")[e];if(a){a.classList.add("current");const o=a.querySelectorAll(".logic-segment");o[t]&&o[t].classList.add("current")}}function ue(){document.querySelectorAll(".series").forEach(e=>e.classList.remove("current")),document.querySelectorAll(".event").forEach(e=>e.classList.remove("current"))}function pe(e){const n=document.querySelectorAll(".logic-timeline-container")[e];if(!n)return;const a=n.querySelector(".logic-timeline-axis");if(!a)return;const o=a.querySelector(".logic-timeline-cursor");o&&o.remove()}const D={program_id:null,running_series_start:null,current_series_index:null,current_event_index:null,target_status_shown:!1};function C(e){Object.assign(D,e)}function w(){const e=document.getElementById("start-btn"),t=document.getElementById("stop-btn"),{program_id:n,running_series_start:a}=D;n!==null&&a===null?(e.classList.remove("hidden"),t.classList.add("hidden")):a!==null?(e.classList.add("hidden"),t.classList.remove("hidden")):(e.classList.add("hidden"),t.classList.add("hidden"))}async function A(){const e=document.getElementById("choose-program"),t=document.getElementById("choose-serie"),n=document.getElementById("run-timeline-wrapper"),a=document.getElementById("run-program-timeline"),o=document.getElementById("start-btn"),d=document.getElementById("stop-btn"),s=document.getElementById("toggle-btn");document.getElementById("chrono");try{const m=await J();e.innerHTML="";const r=document.createElement("option");r.disabled=!0,r.selected=!0,r.textContent="Choose program",e.appendChild(r),m.slice().sort((c,i)=>c.id-i.id).forEach(c=>{const i=document.createElement("option");i.value=c.id,i.textContent=c.title,e.appendChild(i)}),e.addEventListener("change",async()=>{const c=parseInt(e.value,10);if(!isNaN(c)){const i=e.querySelector("option[disabled]");i&&i.remove(),await Q(c);try{const l=await z(c);window.currentProgram=l,V(a,l),I(0,0),C({program_id:c,running_series_start:null}),w(),t.innerHTML="";const u=document.createElement("option");u.disabled=!0,u.selected=!0,u.textContent="Choose a series",t.appendChild(u),l.series.forEach((p,y)=>{const S=document.createElement("option");S.value=y,S.textContent=p.name+(p.optional?" (optional)":""),t.appendChild(S)}),t.classList.remove("hidden"),n.classList.remove("hidden"),o.disabled=!1,d.disabled=!1}catch(l){console.error("Failed to fetch program by ID:",l)}}}),t.addEventListener("change",async()=>{const c=parseInt(t.value,10);isNaN(c)||ne(c)}),o.addEventListener("click",async()=>{await ee()}),d.addEventListener("click",async()=>{await te()}),s.addEventListener("click",async()=>{await de()})}catch(m){console.error("Failed to initialize Run tab:",m)}}document.addEventListener(f.ProgramCompleted,({detail:{program_id:e}})=>{C({program_id:null,running_series_start:null}),ue(),w()});document.addEventListener(f.SeriesStarted,({detail:{program_id:e,series_index:t}})=>{C({program_id:e,running_series_start:new Date,current_series_index:t,current_event_index:0}),I(t,0),document.getElementById("chrono").classList.remove("hidden"),w()});document.addEventListener(f.SeriesCompleted,({detail:{program_id:e,series_index:t}})=>{C({running_series_start:null}),document.getElementById("chrono").classList.add("hidden"),w(),pe(t)});document.addEventListener(f.SeriesStopped,({detail:{program_id:e,series_index:t,event_index:n}})=>{C({program_id:e,running_series_start:null,current_series_index:t,current_event_index:n}),I(t,n),document.getElementById("chrono").classList.add("hidden"),w()});document.addEventListener(f.SeriesNext,({detail:{program_id:e,series_index:t}})=>{C({program_id:e,current_series_index:t,current_event_index:0}),I(t,0),w()});document.addEventListener(f.EventStarted,({detail:{program_id:e,series_index:t,event_index:n}})=>{C({program_id:e,current_series_index:t,current_event_index:n}),I(t,n)});document.addEventListener(f.TargetStatus,({detail:{status:e}})=>{C({target_status_shown:e==="shown"})});document.addEventListener(f.Chrono,({detail:{elapsed:e}})=>{const t=document.getElementById("chrono");t&&(t.textContent=`${Math.floor(e/1e3)}s`);const{current_series_index:n}=D});document.addEventListener(f.ProgramAdded,({detail:{program_id:e}})=>{A()});document.addEventListener(f.ProgramDeleted,({detail:{program_id:e}})=>{A()});document.addEventListener("audio_playback",()=>{});async function M(){try{const e=document.getElementById("audio-container");e.innerHTML="",$.slice().sort((t,n)=>t.id-n.id).forEach(t=>{const n=document.createElement("tr"),a=document.createElement("td");a.textContent=t.id,a.className="id-cell",n.appendChild(a);const o=document.createElement("td");o.textContent=t.title,o.className="title-cell",n.appendChild(o);const d=document.createElement("td");if(!t.readonly){const r=document.createElement("button");r.textContent="Delete",r.classList.add("delete-btn"),r.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${t.title}"?`))try{await se(t.id),alert(`Audio "${t.title}" deleted successfully.`)}catch(c){console.error("Failed to delete audio:",c),alert("Failed to delete audio.")}}),d.appendChild(r)}n.appendChild(d);const s=document.createElement("td"),m=document.createElement("button");m.textContent="JSON",m.classList.add("primary"),m.addEventListener("click",()=>{const r=JSON.stringify(t,null,2),c=new Blob([r],{type:"application/json"}),i=URL.createObjectURL(c);window.open(i,"_blank")}),s.appendChild(m),n.appendChild(s),e.appendChild(n)})}catch(e){console.error("Error loading audios:",e)}}async function ge(){const e=document.getElementById("audio-file"),t=document.getElementById("audio-title");e.addEventListener("change",()=>{const a=e.files[0];if(a){const o=a.name.lastIndexOf("."),d=o>0?a.name.substring(0,o):a.name;t.value=d}});const n=document.getElementById("audio-form");n.addEventListener("submit",async a=>{a.preventDefault();const o=document.getElementById("audio-file").files[0],d=document.getElementById("audio-title").value,s=document.getElementById("audio-codec").value;if(!(!o||!d||!s))try{await ae(o,s,d),n.reset()}catch(m){console.error("Upload failed:",m),alert("Upload failed")}}),await M()}document.addEventListener(f.AudioAdded,async({detail:{id:e}})=>{await R(),await M(),console.log("Audio added:",e)});document.addEventListener(f.AudioDeleted,async({detail:{id:e}})=>{await R(),await M(),console.log("Audio deleted:",e)});const x=document.getElementById("program-file"),fe=document.getElementById("add-program-btn");function K(e=null,t=null){x.onchange=async n=>{const a=n.target.files[0];if(!a)return;const o=new FileReader;o.onload=async d=>{try{const s=JSON.parse(d.target.result);await Y(s,e),alert(e?`Program "${t}" updated successfully.`:"Program added successfully!"),await _()}catch(s){alert(e?`Failed to update program: ${s.message}`:`Failed to add program: ${s.message}`)}},o.readAsText(a)},x.value="",x.click()}async function _(){try{const e=document.getElementById("programs-container"),t=await J();e.innerHTML="",t.slice().sort((n,a)=>n.id-a.id).forEach(n=>{const a=document.createElement("tr"),o=document.createElement("td");o.textContent=n.id,o.className="id-cell",a.appendChild(o);const d=document.createElement("td");d.textContent=n.title,d.className="title-cell",a.appendChild(d);const s=document.createElement("td");if(!n.readonly){const i=document.createElement("button");i.textContent="Delete",i.classList.add("delete-btn"),i.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${n.title}"?`))try{await Z(n.id),alert(`Program "${n.title}" deleted successfully.`),await _()}catch(l){console.error("Failed to delete program:",l),alert("Failed to delete program.")}}),s.appendChild(i)}a.appendChild(s);const m=document.createElement("td");if(!n.readonly){const i=document.createElement("button");i.textContent="Update",i.classList.add("primary"),i.addEventListener("click",async()=>{K(n.id,n.title)}),m.appendChild(i)}a.appendChild(m);const r=document.createElement("td"),c=document.createElement("button");c.textContent="JSON",c.classList.add("primary"),c.addEventListener("click",async()=>{try{const i=await z(n.id),l=JSON.stringify(i,null,2),u=new Blob([l],{type:"application/json"}),p=URL.createObjectURL(u);window.open(p,"_blank")}catch{alert("Failed to fetch full program JSON.")}}),r.appendChild(c),a.appendChild(r),e.appendChild(a)})}catch(e){console.error("Error loading programs:",e)}}async function he(){const e=document.getElementById("upload-programs-timeline-wrapper"),t=document.getElementById("upload-programs-timeline");x.addEventListener("change",n=>{const a=n.target.files[0];if(!a)return;const o=new FileReader;o.onload=d=>{const s=JSON.parse(d.target.result);V(t,s),e.classList.remove("hidden")},o.readAsText(a)}),await _()}fe.addEventListener("click",()=>{K()});document.addEventListener(f.ProgramAdded,async({detail:{id:e}})=>{await _(),console.log("Program added:",e)});document.addEventListener(f.ProgramDeleted,async({detail:{id:e}})=>{await _(),console.log("Program deleted:",e)});document.addEventListener("program_updated",async({detail:e})=>{await _(),console.log("Program updated:",e==null?void 0:e.program_id)});document.addEventListener("DOMContentLoaded",async()=>{const n="MalmÃ¶ Skyttegille Rotation Target v0.6.0";document.title=n,document.querySelector("#footer span").textContent=n;try{await R()}catch(l){console.error("Failed to load audios:",l)}await A();const a=document.getElementById("run-tab-button"),o=document.getElementById("audio-tab-button"),d=document.getElementById("programs-tab-button"),s=document.getElementById("settings-tab-button"),m=document.getElementById("run-section"),r=document.getElementById("audio-section"),c=document.getElementById("programs-section"),i=document.getElementById("settings-section");a.addEventListener("click",async()=>{a.classList.add("active"),o.classList.remove("active"),d.classList.remove("active"),s.classList.remove("active"),m.classList.remove("hidden"),r.classList.add("hidden"),c.classList.add("hidden"),i.classList.add("hidden"),await A()}),o.addEventListener("click",async()=>{o.classList.add("active"),a.classList.remove("active"),d.classList.remove("active"),s.classList.remove("active"),r.classList.remove("hidden"),m.classList.add("hidden"),c.classList.add("hidden"),i.classList.add("hidden"),await ge()}),d.addEventListener("click",()=>{d.classList.add("active"),a.classList.remove("active"),o.classList.remove("active"),s.classList.remove("active"),c.classList.remove("hidden"),m.classList.add("hidden"),r.classList.add("hidden"),i.classList.add("hidden"),he()}),s.addEventListener("click",()=>{s.classList.add("active"),a.classList.remove("active"),o.classList.remove("active"),d.classList.remove("active"),i.classList.remove("hidden"),m.classList.add("hidden"),r.classList.add("hidden"),c.classList.add("hidden"),q()}),N((l,u)=>{const p=new CustomEvent(l,{detail:u});document.dispatchEvent(p)})});
