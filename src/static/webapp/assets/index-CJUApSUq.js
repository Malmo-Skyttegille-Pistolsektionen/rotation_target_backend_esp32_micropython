(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const s of d.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function a(o){if(o.ep)return;o.ep=!0;const d=n(o);fetch(o.href,d)}})();const f={ProgramAdded:"program_added",ProgramDeleted:"program_deleted",ProgramStarted:"program_started",ProgramCompleted:"program_completed",SeriesStarted:"series_started",SeriesCompleted:"series_completed",SeriesStopped:"series_stopped",SeriesNext:"series_next",EventStarted:"event_started",TargetStatus:"target_status",AudioAdded:"audio_added",AudioDeleted:"audio_deleted",Chrono:"chrono",AdminModeStatus:"admin_mode_status"};let L=null;function N(e){return L&&L.close(),L=new EventSource(j,{withCredentials:!1}),Object.values(f).forEach(t=>{L.addEventListener(t,n=>{try{const a=JSON.parse(n.data);console.log("Received SSE event:",t,a),e(t,a)}catch(a){console.error("Failed to parse event:",t,a)}})}),L.onopen=()=>{console.log("SSE connection established")},L.onerror=t=>{console.error("SSE connection error:",t)},L}const X=()=>localStorage.getItem("SERVER_BASE_URL")||"http://localhost:8080";let b=X(),g=`${b}/api/v1`,j=`${b}/sse/v1`,B=localStorage.getItem("ADMIN_BEARER_TOKEN")||null;function G(e){b=e,g=`${b}/api/v1`,j=`${b}/sse/v1`,localStorage.setItem("SERVER_BASE_URL",e),typeof N=="function"&&(L&&L.close(),N())}function q(){const e=document.getElementById("settings-form"),t=document.getElementById("server-base-url"),n=document.getElementById("settings-status"),a=document.getElementById("admin-enable-form"),o=document.getElementById("admin-disable-form"),d=document.getElementById("admin-password"),s=document.getElementById("admin-mode-status");t.value=b,e.onsubmit=i=>{i.preventDefault();const l=t.value.trim();if(!l||!Y(l)){n.textContent="Please enter a valid URL.",n.style.color="red";return}G(l),n.textContent="Server Base URL updated!",n.style.color="green",c()},a.onsubmit=async i=>{i.preventDefault();const l=d.value;s.textContent="";try{B=(await ce(l)).token,localStorage.setItem("ADMIN_BEARER_TOKEN",B),d.value="",s.textContent="Admin mode enabled!",s.style.color="green",c()}catch{s.textContent="Failed to enable admin mode.",s.style.color="red"}},o.onsubmit=async i=>{i.preventDefault(),s.textContent="";try{await le(B),B=null,localStorage.removeItem("ADMIN_BEARER_TOKEN"),s.textContent="Admin mode disabled!",s.style.color="green",c()}catch{s.textContent="Failed to disable admin mode.",s.style.color="red"}};async function c(){try{const{enabled:i}=await re();i?B?(a.classList.add("hidden"),o.classList.remove("hidden"),s.textContent="Admin mode is enabled.",s.style.color="green"):(a.classList.add("hidden"),o.classList.add("hidden"),s.textContent="Admin mode is enabled (by another client).",s.style.color="orange"):(a.classList.remove("hidden"),o.classList.add("hidden"),s.textContent="Admin mode is disabled.",s.style.color="gray")}catch{s.textContent="Could not fetch admin mode status.",s.style.color="red"}}q.updateAdminModeUI=c,c()}function Y(e){try{const t=new URL(e);return/^https?:$/.test(t.protocol)&&(/^[a-zA-Z0-9.-]+$/.test(t.hostname)||/^(\d{1,3}\.){3}\d{1,3}$/.test(t.hostname))?/^(\d{1,3}\.){3}\d{1,3}$/.test(t.hostname)?t.hostname.split(".").every(n=>{const a=Number(n);return a>=0&&a<=255}):!0:!1}catch{return!1}}const v=Object.freeze({GET:"GET",POST:"POST",PUT:"PUT",DELETE:"DELETE",PATCH:"PATCH"});async function J(){const e=await fetch(`${g}/programs`);return h(e)}async function z(e){const t=await fetch(`${g}/programs/${e}`);return h(t)}async function Z(e,t){const n=t?`${g}/programs/${t}/update`:`${g}/programs`,a=t?v.PUT:v.POST,o=await y(n,{method:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return h(o)}async function Q(e){const t=await y(`${g}/programs/${e}/delete`,{method:v.DELETE,headers:{"Content-Type":"application/json"}});return h(t)}async function ee(e){const t=await y(`${g}/programs/${e}/load`,{method:"POST"});return h(t)}async function te(){const e=await y(`${g}/programs/start`,{method:"POST"});return h(e)}async function ne(){const e=await y(`${g}/programs/stop`,{method:"POST"});return h(e)}async function oe(e){const t=await y(`${g}/programs/series/${e}/skip_to`,{method:v.POST,headers:{"Content-Type":"application/json"}});return h(t)}async function ae(){const e=await fetch(`${g}/audios`);return h(e)}async function se(e,t,n){const a=new FormData;a.append("file",e),a.append("codec",t),a.append("title",n);const o=await y(`${g}/audios`,{method:v.POST,body:a});return h(o)}async function de(e){const t=await y(`${g}/audios/${e}/delete`,{method:v.DELETE,headers:{"Content-Type":"application/json"}});return h(t)}async function ie(){const e=await y(`${g}/targets/toggle`,{method:"POST"});return h(e)}async function re(){const e=await fetch(`${g}/admin-mode/status`);return h(e)}async function ce(e){const t=await fetch(`${g}/admin-mode/enable`,{method:v.POST,headers:{"Content-Type":"application/json"},body:JSON.stringify({password:e})});return h(t)}async function le(){const e=await y(`${g}/admin-mode/disable`,{method:v.POST});return h(e)}async function h(e){if(console.log("Response status:",e.status,e.statusText),!e.ok)throw new Error(`Request failed: ${e.statusText}`);const t=e.headers.get("Content-Type");return t&&t.includes("application/json")?e.json():null}async function y(e,t={}){const n=localStorage.getItem("ADMIN_BEARER_TOKEN");return t.headers=t.headers||{},n&&(t.headers.Authorization=`Bearer ${n}`),await fetch(e,t)}let x=[];async function R(){const e=await ae();return console.log("fetchAudios data:",e),x=e.audios||[],console.log("audios:",x),x}function O(e){return x.find(n=>n.id===e).title}async function D(){try{const e=document.getElementById("audio-container");e.innerHTML="",x.slice().sort((t,n)=>t.id-n.id).forEach(t=>{const n=document.createElement("tr"),a=document.createElement("td");a.textContent=t.id,a.className="id-cell",n.appendChild(a);const o=document.createElement("td");o.textContent=t.title,o.className="title-cell",n.appendChild(o);const d=document.createElement("td");if(!t.readonly){const i=document.createElement("button");i.textContent="Delete",i.classList.add("delete-btn"),i.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${t.title}"?`))try{await de(t.id),alert(`Audio "${t.title}" deleted successfully.`)}catch(l){console.error("Failed to delete audio:",l),alert("Failed to delete audio.")}}),d.appendChild(i)}n.appendChild(d);const s=document.createElement("td"),c=document.createElement("button");c.textContent="JSON",c.classList.add("primary"),c.addEventListener("click",()=>{const i=JSON.stringify(t,null,2),l=new Blob([i],{type:"application/json"}),r=URL.createObjectURL(l);window.open(r,"_blank")}),s.appendChild(c),n.appendChild(s),e.appendChild(n)})}catch(e){console.error("Error loading audios:",e)}}async function me(){const e=document.getElementById("audio-file"),t=document.getElementById("audio-title");e.addEventListener("change",()=>{const a=e.files[0];if(a){const o=a.name.lastIndexOf("."),d=o>0?a.name.substring(0,o):a.name;t.value=d}});const n=document.getElementById("audio-form");n.addEventListener("submit",async a=>{a.preventDefault();const o=document.getElementById("audio-file").files[0],d=document.getElementById("audio-title").value,s=document.getElementById("audio-codec").value;if(!(!o||!d||!s))try{await se(o,s,d),n.reset()}catch(c){console.error("Upload failed:",c),alert("Upload failed")}}),await D()}document.addEventListener(f.AudioAdded,async({detail:{id:e}})=>{await R(),await D(),console.log("Audio added:",e)});document.addEventListener(f.AudioDeleted,async({detail:{id:e}})=>{await R(),await D(),console.log("Audio deleted:",e)});const k=Object.freeze({Default:"default",Field:"field"});let U=null;function V(e,t,n=k.Field){n===k.Field?pe(e,t):ue(e,t)}function ue(e,t){e.innerHTML="",U=H(t.series);let n=document.createElement("div");n.className="timeline-tooltip",e.appendChild(n),U.forEach((a,o)=>{const d=document.createElement("div");d.className="series",a.optional&&d.classList.add("optional"),d.dataset.seriesIndex=o;const s=document.createElement("div");s.className="series-title",s.textContent=a.name+(a.optional?" (optional)":""),d.appendChild(s);const c=document.createElement("div");c.className="events",a.events.forEach((i,l)=>{const r=document.createElement("div");r.className=`event ${i.symbolClass}`,r.dataset.eventIndex=l,r.addEventListener("mouseenter",()=>{let E="";i.audio_ids&&i.audio_ids.length>0&&(E="<br>Audios:<br>"+i.audio_ids.map(T=>{const I=O(T);return`${T}. ${I}`}).join("<br>")),n.innerHTML=`<strong>Duration:</strong> ${Math.trunc(i.duration/1e3)}s<br><strong>Command:</strong> ${i.command||"none"}${E}`,n.style.display="block";const C=r.getBoundingClientRect();n.style.left=`${C.left+window.scrollX}px`,n.style.top=`${C.top+window.scrollY-40}px`}),r.addEventListener("mouseleave",()=>{n.style.display="none"});const m=document.createElement("div");m.className="dur",m.textContent=Math.trunc(i.duration/1e3),r.appendChild(m);const u=document.createElement("div");u.className="symbol",u.textContent=i.symbolText,r.appendChild(u);const p=document.createElement("div");if(p.className="acc",p.textContent=Math.trunc(i.acc/1e3),r.appendChild(p),i.audio_ids&&i.audio_ids.length>0){const E=i.audio_ids.map(O).join(", ");r.setAttribute("title",E)}c.appendChild(r)}),d.appendChild(c),e.appendChild(d)})}function pe(e,t){e.innerHTML="";let n=document.createElement("div");n.className="logic-timeline-tooltip",e.appendChild(n),H(t.series).forEach((o,d)=>{const s=document.createElement("div");s.className="logic-timeline-container",o.optional&&s.classList.add("optional"),s.dataset.seriesIndex=d;const c=document.createElement("div");c.className="series-title",c.textContent=o.name+(o.optional?" (optional)":""),s.appendChild(c);const i=document.createElement("div");i.className="logic-timeline-centerline";let l=0;o.events.forEach(m=>{const u=Math.max(1,Math.trunc(m.duration/1e3)),p=document.createElement("div");p.className=`logic-segment ${m.command||""}`,p.style.width=`${u*40}px`,p.dataset.duration=m.duration;const E=document.createElement("div");E.className="logic-info-line",E.textContent=`${u}s`,m.audio_ids&&(E.textContent+=" A"),p.appendChild(E),p.addEventListener("mouseenter",C=>{let T="";m.audio_ids&&m.audio_ids.length>0&&(T="<br>Audios:<br>"+m.audio_ids.map(F=>{const W=O(F);return`${F}. ${W}`}).join("<br>")),n.innerHTML=`<strong>Duration:</strong> ${u}s<br><strong>Command:</strong> ${m.command||"none"}${T}`,n.style.display="block";const I=p.getBoundingClientRect();n.style.left=`${I.left+window.scrollX}px`,n.style.top=`${I.top+window.scrollY-40}px`}),p.addEventListener("mouseleave",()=>{n.style.display="none"}),m.command==="show"?p.classList.add("above"):m.command==="hide"&&p.classList.add("on-line"),p.title=`${m.command||""} (${u}s)`,i.appendChild(p),l+=u});const r=document.createElement("div");r.className="logic-timeline-axis",r.style.position="relative",r.style.width=`${l*40}px`;for(let m=0;m<=l;m++){const u=document.createElement("span");u.className="logic-timeline-tick",u.textContent=m,u.id=`logic-tick-${d}-${m}`,u.dataset.seriesIndex=d,u.dataset.second=m,u.style.position="absolute",u.style.left=`${m*40}px`,u.style.transform="translateX(-50%)",r.appendChild(u)}s.appendChild(i),s.appendChild(r),e.appendChild(s)})}function H(e){return e.map(t=>{let n=0;const a=t.events.map(o=>{const d=o.duration;let s="no-action",c="";o.command==="show"&&o.audio_ids?(s="show audio",c="A"):o.command==="hide"&&o.audio_ids?(s="hide audio",c="A"):o.command==="show"?s="show":o.command==="hide"?s="hide":o.audio_ids&&(s="audio",c="A");const i={...o,duration:d,acc:n,symbolClass:s,symbolText:c};return n+=d,i});return{...t,events:a}})}function A(e,t){document.querySelectorAll(".series").forEach(o=>o.classList.remove("current")),document.querySelectorAll(".event").forEach(o=>o.classList.remove("current")),document.querySelectorAll(".logic-segment").forEach(o=>o.classList.remove("current")),document.querySelectorAll(".logic-timeline-container").forEach(o=>o.classList.remove("current"));const n=document.querySelector(`[data-series-index='${e}']`);if(n){n.classList.add("current");const o=n.querySelector(`[data-event-index='${t}']`);o&&o.classList.add("current")}const a=document.querySelectorAll(".logic-timeline-container")[e];if(a){a.classList.add("current");const o=a.querySelectorAll(".logic-segment");o[t]&&o[t].classList.add("current")}}function ge(){document.querySelectorAll(".series").forEach(e=>e.classList.remove("current")),document.querySelectorAll(".event").forEach(e=>e.classList.remove("current"))}function fe(e){const n=document.querySelectorAll(".logic-timeline-container")[e];if(!n)return;const a=n.querySelector(".logic-timeline-axis");if(!a)return;const o=a.querySelector(".logic-timeline-cursor");o&&o.remove()}const M={program_id:null,running_series_start:null,current_series_index:null,current_event_index:null,target_status_shown:!1};function S(e){Object.assign(M,e)}function w(){const e=document.getElementById("start-btn"),t=document.getElementById("stop-btn"),{program_id:n,running_series_start:a}=M;n!==null&&a===null?(e.classList.remove("hidden"),t.classList.add("hidden")):a!==null?(e.classList.add("hidden"),t.classList.remove("hidden")):(e.classList.add("hidden"),t.classList.add("hidden"))}async function P(){const e=document.getElementById("choose-program"),t=document.getElementById("choose-serie"),n=document.getElementById("run-timeline-wrapper"),a=document.getElementById("run-program-timeline"),o=document.getElementById("start-btn"),d=document.getElementById("stop-btn"),s=document.getElementById("toggle-btn");document.getElementById("chrono");try{const c=await J();console.log("Fetched programs:",c),e.innerHTML="";const i=document.createElement("option");i.disabled=!0,i.selected=!0,i.textContent="Choose program",e.appendChild(i),c.forEach(l=>{const r=document.createElement("option");r.value=l.id,r.textContent=l.title,e.appendChild(r)}),e.addEventListener("change",async()=>{const l=parseInt(e.value,10);if(!isNaN(l)){const r=e.querySelector("option[disabled]");r&&r.remove(),await ee(l);try{const m=await z(l);window.currentProgram=m,V(a,m),A(0,0),S({program_id:l,running_series_start:null}),w(),t.innerHTML="";const u=document.createElement("option");u.disabled=!0,u.selected=!0,u.textContent="Choose a series",t.appendChild(u),m.series.forEach((p,E)=>{const C=document.createElement("option");C.value=E,C.textContent=p.name+(p.optional?" (optional)":""),t.appendChild(C)}),t.classList.remove("hidden"),n.classList.remove("hidden"),o.disabled=!1,d.disabled=!1}catch(m){console.error("Failed to fetch program by ID:",m)}}}),t.addEventListener("change",async()=>{const l=parseInt(t.value,10);isNaN(l)||oe(l)}),o.addEventListener("click",async()=>{await te()}),d.addEventListener("click",async()=>{await ne()}),s.addEventListener("click",async()=>{await ie()})}catch(c){console.error("Failed to initialize Run tab:",c)}}document.addEventListener(f.ProgramCompleted,({detail:{program_id:e}})=>{S({program_id:null,running_series_start:null}),ge(),w()});document.addEventListener(f.SeriesStarted,({detail:{program_id:e,series_index:t}})=>{S({program_id:e,running_series_start:new Date,current_series_index:t,current_event_index:0}),A(t,0),document.getElementById("chrono").classList.remove("hidden"),w()});document.addEventListener(f.SeriesCompleted,({detail:{program_id:e,series_index:t}})=>{S({running_series_start:null}),document.getElementById("chrono").classList.add("hidden"),w(),fe(t)});document.addEventListener(f.SeriesStopped,({detail:{program_id:e,series_index:t,event_index:n}})=>{S({program_id:e,running_series_start:null,current_series_index:t,current_event_index:n}),A(t,n),document.getElementById("chrono").classList.add("hidden"),w()});document.addEventListener(f.SeriesNext,({detail:{program_id:e,series_index:t}})=>{S({program_id:e,current_series_index:t,current_event_index:0}),A(t,0),w()});document.addEventListener(f.EventStarted,({detail:{program_id:e,series_index:t,event_index:n}})=>{S({program_id:e,current_series_index:t,current_event_index:n}),A(t,n)});document.addEventListener(f.TargetStatus,({detail:{status:e}})=>{S({target_status_shown:e==="shown"})});document.addEventListener(f.Chrono,({detail:{elapsed:e}})=>{const t=document.getElementById("chrono");t&&(t.textContent=`${Math.floor(e/1e3)}s`);const{current_series_index:n}=M});document.addEventListener(f.ProgramAdded,({detail:{program_id:e}})=>{P()});document.addEventListener(f.ProgramDeleted,({detail:{program_id:e}})=>{P()});document.addEventListener("audio_playback",()=>{});const $=document.getElementById("program-file"),he=document.getElementById("add-program-btn");function K(e=null,t=null){$.onchange=async n=>{const a=n.target.files[0];if(!a)return;const o=new FileReader;o.onload=async d=>{try{const s=JSON.parse(d.target.result);await Z(s,e),alert(e?`Program "${t}" updated successfully.`:"Program added successfully!"),await _()}catch(s){alert(e?`Failed to update program: ${s.message}`:`Failed to add program: ${s.message}`)}},o.readAsText(a)},$.value="",$.click()}async function _(){try{const e=document.getElementById("programs-container"),t=await J();e.innerHTML="",t.slice().sort((n,a)=>n.id-a.id).forEach(n=>{const a=document.createElement("tr"),o=document.createElement("td");o.textContent=n.id,o.className="id-cell",a.appendChild(o);const d=document.createElement("td");d.textContent=n.title,d.className="title-cell",a.appendChild(d);const s=document.createElement("td");if(!n.readonly){const r=document.createElement("button");r.textContent="Delete",r.classList.add("delete-btn"),r.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${n.title}"?`))try{await Q(n.id),alert(`Program "${n.title}" deleted successfully.`),await _()}catch(m){console.error("Failed to delete program:",m),alert("Failed to delete program.")}}),s.appendChild(r)}a.appendChild(s);const c=document.createElement("td");if(!n.readonly){const r=document.createElement("button");r.textContent="Update",r.classList.add("primary"),r.addEventListener("click",async()=>{K(n.id,n.title)}),c.appendChild(r)}a.appendChild(c);const i=document.createElement("td"),l=document.createElement("button");l.textContent="JSON",l.classList.add("primary"),l.addEventListener("click",async()=>{try{const r=await z(n.id),m=JSON.stringify(r,null,2),u=new Blob([m],{type:"application/json"}),p=URL.createObjectURL(u);window.open(p,"_blank")}catch{alert("Failed to fetch full program JSON.")}}),i.appendChild(l),a.appendChild(i),e.appendChild(a)})}catch(e){console.error("Error loading programs:",e)}}async function Ee(){const e=document.getElementById("upload-programs-timeline-wrapper"),t=document.getElementById("upload-programs-timeline");$.addEventListener("change",n=>{const a=n.target.files[0];if(!a)return;const o=new FileReader;o.onload=d=>{const s=JSON.parse(d.target.result);V(t,s),e.classList.remove("hidden")},o.readAsText(a)}),await _()}he.addEventListener("click",()=>{K()});document.addEventListener(f.ProgramAdded,async({detail:{id:e}})=>{await _(),console.log("Program added:",e)});document.addEventListener(f.ProgramDeleted,async({detail:{id:e}})=>{await _(),console.log("Program deleted:",e)});document.addEventListener("program_updated",async({detail:e})=>{await _(),console.log("Program updated:",e==null?void 0:e.program_id)});document.addEventListener("DOMContentLoaded",async()=>{const n="MalmÃ¶ Skyttegille Rotation Target v0.4.1";document.title=n,document.querySelector("#footer span").textContent=n,await R(),await P();const a=document.getElementById("run-tab-button"),o=document.getElementById("audio-tab-button"),d=document.getElementById("programs-tab-button"),s=document.getElementById("settings-tab-button"),c=document.getElementById("run-section"),i=document.getElementById("audio-section"),l=document.getElementById("programs-section"),r=document.getElementById("settings-section");a.addEventListener("click",async()=>{a.classList.add("active"),o.classList.remove("active"),d.classList.remove("active"),s.classList.remove("active"),c.classList.remove("hidden"),i.classList.add("hidden"),l.classList.add("hidden"),r.classList.add("hidden"),await P()}),o.addEventListener("click",async()=>{o.classList.add("active"),a.classList.remove("active"),d.classList.remove("active"),s.classList.remove("active"),i.classList.remove("hidden"),c.classList.add("hidden"),l.classList.add("hidden"),r.classList.add("hidden"),await me()}),d.addEventListener("click",()=>{d.classList.add("active"),a.classList.remove("active"),o.classList.remove("active"),s.classList.remove("active"),l.classList.remove("hidden"),c.classList.add("hidden"),i.classList.add("hidden"),r.classList.add("hidden"),Ee()}),s.addEventListener("click",()=>{s.classList.add("active"),a.classList.remove("active"),o.classList.remove("active"),d.classList.remove("active"),r.classList.remove("hidden"),c.classList.add("hidden"),i.classList.add("hidden"),l.classList.add("hidden"),q()}),N((m,u)=>{console.log("SSE Event:",m,u);const p=new CustomEvent(m,{detail:u});document.dispatchEvent(p)})});
