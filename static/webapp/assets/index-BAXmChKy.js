(function () { const t = document.createElement("link").relList; if (t && t.supports && t.supports("modulepreload")) return; for (const n of document.querySelectorAll('link[rel="modulepreload"]')) a(n); new MutationObserver(n => { for (const r of n) if (r.type === "childList") for (const s of r.addedNodes) s.tagName === "LINK" && s.rel === "modulepreload" && a(s) }).observe(document, { childList: !0, subtree: !0 }); function o(n) { const r = {}; return n.integrity && (r.integrity = n.integrity), n.referrerPolicy && (r.referrerPolicy = n.referrerPolicy), n.crossOrigin === "use-credentials" ? r.credentials = "include" : n.crossOrigin === "anonymous" ? r.credentials = "omit" : r.credentials = "same-origin", r } function a(n) { if (n.ep) return; n.ep = !0; const r = o(n); fetch(n.href, r) } })(); let _ = null; function w(e, t) { e.innerHTML = "", _ = I(t.series), _.forEach((o, a) => { const n = document.createElement("div"); n.className = "series", o.optional && n.classList.add("optional"), n.dataset.seriesIndex = a; const r = document.createElement("div"); r.textContent = o.name + (o.optional ? " (optional)" : ""), n.appendChild(r); const s = document.createElement("div"); s.className = "events", o.events.forEach((d, c) => { const i = document.createElement("div"); i.className = `event ${d.symbolClass}`, i.dataset.eventIndex = c; const l = document.createElement("div"); l.className = "dur", l.textContent = d.duration, i.appendChild(l); const u = document.createElement("div"); u.className = "symbol", u.textContent = d.symbolText, i.appendChild(u); const h = document.createElement("div"); h.className = "acc", h.textContent = d.acc, i.appendChild(h), s.appendChild(i) }), n.appendChild(s), e.appendChild(n) }) } function I(e) { return e.map(t => { let o = 0; const a = t.events.map(n => { const r = n.duration; let s = "no-action", d = ""; n.command === "show" && n.audio_ids ? (s = "show audio", d = "A") : n.command === "hide" && n.audio_ids ? (s = "hide audio", d = "A") : n.command === "show" ? s = "show" : n.command === "hide" ? s = "hide" : n.audio_ids && (s = "audio", d = "A"); const c = { ...n, duration: r, acc: o, symbolClass: s, symbolText: d }; return o += r, c }); return { ...t, events: a } }) } function v(e, t) { document.querySelectorAll(".series").forEach(a => a.classList.remove("current")), document.querySelectorAll(".event").forEach(a => a.classList.remove("current")); const o = document.querySelector(`[data-series-index='${e}']`); if (o) { o.classList.add("current"); const a = o.querySelector(`[data-event-index='${t}']`); a && a.classList.add("current") } } function T() { document.querySelectorAll(".series").forEach(e => e.classList.remove("current")), document.querySelectorAll(".event").forEach(e => e.classList.remove("current")) } const C = "http://192.168.53:8080", p = `${C}/api/v1`, P = `${C}/sse/v1`; async function x() { const e = await fetch(`${p}/programs`); return g(e) } async function $(e) { const t = await fetch(`${p}/programs/${e}`); return g(t) } async function A(e) { const t = await fetch(`${p}/programs`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(e) }); return g(t) } async function O(e) { const t = await fetch(`${p}/programs/${e}/load`, { method: "POST" }); return g(t) } async function N() { const e = await fetch(`${p}/programs/start`, { method: "POST" }); return g(e) } async function R() { const e = await fetch(`${p}/programs/stop`, { method: "POST" }); return g(e) } async function D(e) { const t = await fetch(`${p}/programs/series/${e}/skip_to`, { method: "POST", headers: { "Content-Type": "application/json" } }); return g(t) } async function F() { const e = await fetch(`${p}/audios`); return g(e) } async function U({ file: e, codec: t, title: o }) { const a = new FormData; a.append("file", e), a.append("codec", t), a.append("title", o); const n = await fetch(`${p}/audios`, { method: "POST", body: a }); return g(n) } async function j(e) { const t = await fetch(`${p}/audios/${e}/delete`, { method: "DELETE", headers: { "Content-Type": "application/json" } }); return g(t) } async function g(e) { if (console.log("Response status:", e.status, e.statusText), !e.ok) throw new Error("Request failed: ${response.statusText}"); const t = e.headers.get("Content-Type"); return t && t.includes("application/json") ? e.json() : null } const m = { ProgramUploaded: "program_uploaded", ProgramStarted: "program_started", ProgramCompleted: "program_completed", SeriesStarted: "series_started", SeriesCompleted: "series_completed", SeriesStopped: "series_stopped", SeriesNext: "series_next", EventStarted: "event_started", TargetStatus: "target_status", AudioAdded: "audio_added", AudioDeleted: "audio_deleted", Chrono: "chrono" }; function q(e) { const t = new EventSource(`${P}`, { withCredentials: !1 }); return Object.values(m).forEach(o => { t.addEventListener(o, a => { try { const n = JSON.parse(a.data); console.log("Received SSE event:", o, n), e(o, n) } catch (n) { console.error("Failed to parse event:", o, n) } }) }), t.onopen = () => { console.log("SSE connection established") }, t.onerror = o => { console.error("SSE connection error:", o) }, t } const b = { program_id: null, running_series_start: null, current_series_index: null, current_event_index: null, target_status_shown: !1 }; function f(e) { Object.assign(b, e) } function E() { const e = document.getElementById("start-btn"), t = document.getElementById("stop-btn"), { program_id: o, running_series_start: a } = b; o !== null && a === null ? (e.classList.remove("hidden"), t.classList.add("hidden")) : a !== null ? (e.classList.add("hidden"), t.classList.remove("hidden")) : (e.classList.add("hidden"), t.classList.add("hidden")) } async function M() { const e = document.getElementById("choose-program"), t = document.getElementById("choose-serie"), o = document.getElementById("show-json"), a = document.getElementById("programs-timeline-wrapper"), n = document.getElementById("programs-timeline"), r = document.getElementById("start-btn"), s = document.getElementById("stop-btn"); document.getElementById("chrono"); try { const d = await x(); console.log("Fetched programs:", d), e.innerHTML = ""; const c = document.createElement("option"); c.disabled = !0, c.selected = !0, c.textContent = "Choose program", e.appendChild(c), d.forEach(i => { const l = document.createElement("option"); l.value = i.id, l.textContent = i.title, e.appendChild(l) }), e.addEventListener("change", async () => { const i = parseInt(e.value, 10); if (!isNaN(i)) { const l = e.querySelector("option[disabled]"); l && l.remove(), await O(i); try { const u = await $(i); window.currentProgram = u, w(n, u), v(0, 0), f({ program_id: i, running_series_start: null }), E(), t.innerHTML = ""; const h = document.createElement("option"); h.disabled = !0, h.selected = !0, h.textContent = "Choose a series", t.appendChild(h), u.series.forEach((S, B) => { const L = document.createElement("option"); L.value = B, L.textContent = S.name + (S.optional ? " (optional)" : ""), t.appendChild(L) }), t.classList.remove("hidden"), o.classList.remove("hidden"), a.classList.remove("hidden"), r.disabled = !1, s.disabled = !1 } catch (u) { console.error("Failed to fetch program by ID:", u) } } }), t.addEventListener("change", async () => { const i = parseInt(t.value, 10); isNaN(i) || D(i) }), o.addEventListener("click", () => { if (window.currentProgram) { const i = JSON.stringify(window.currentProgram, null, 2), l = new Blob([i], { type: "application/json" }), u = URL.createObjectURL(l); window.open(u, "_blank") } }), r.addEventListener("click", async () => { await N() }), s.addEventListener("click", async () => { await R() }) } catch (d) { console.error("Failed to initialize Programs tab:", d) } } document.addEventListener(m.ProgramCompleted, ({ detail: { program_id: e } }) => { f({ program_id: null, running_series_start: null }), T(), E() }); document.addEventListener(m.SeriesStarted, ({ detail: { program_id: e, series_index: t } }) => { f({ program_id: e, running_series_start: new Date, current_series_index: t, current_event_index: 0 }), v(t, 0), document.getElementById("chrono").classList.remove("hidden"), E() }); document.addEventListener(m.SeriesCompleted, ({ detail: { program_id: e } }) => { f({ running_series_start: null }), document.getElementById("chrono").classList.add("hidden"), E() }); document.addEventListener(m.SeriesStopped, ({ detail: { program_id: e, series_index: t, event_index: o } }) => { f({ program_id: e, running_series_start: null, current_series_index: t, current_event_index: o }), v(t, o), document.getElementById("chrono").classList.add("hidden"), E() }); document.addEventListener(m.SeriesNext, ({ detail: { program_id: e, series_index: t } }) => { f({ program_id: e, current_series_index: t, current_event_index: 0 }), v(t, 0), E() }); document.addEventListener(m.EventStarted, ({ detail: { program_id: e, series_index: t, event_index: o } }) => { f({ program_id: e, current_series_index: t, current_event_index: o }), v(t, o) }); document.addEventListener(m.TargetStatus, ({ detail: { status: e } }) => { f({ target_status_shown: e === "shown" }) }); document.addEventListener(m.Chrono, ({ detail: { elapsed: e } }) => { const t = document.getElementById("chrono"); t && (t.textContent = `${Math.floor(e / 1e3)}s`) }); async function y() { try { const e = document.getElementById("audio-container"), { builtin: t = [], uploaded: o = [] } = await F(); if (e.innerHTML = "", t.length > 0) { const a = document.createElement("h3"); a.textContent = "Built-in:", e.appendChild(a); const n = document.createElement("ul"); t.forEach(r => { const s = document.createElement("li"); s.textContent = `${r.id}: ${r.title}`, n.appendChild(s) }), e.appendChild(n) } if (o.length > 0) { const a = document.createElement("h3"); a.textContent = "Uploaded:", e.appendChild(a); const n = document.createElement("ul"); o.forEach(r => { const s = document.createElement("li"); s.textContent = `${r.id}: ${r.title}`; const d = document.createElement("button"); d.textContent = "Delete", d.classList.add("delete-btn"), d.addEventListener("click", async () => { if (confirm(`Are you sure you want to delete "${r.title}"?`)) try { await j(r.id), alert(`Audio "${r.title}" deleted successfully.`), await y() } catch (c) { console.error("Failed to delete audio:", c), alert("Failed to delete audio.") } }), s.appendChild(d), n.appendChild(s) }), e.appendChild(n) } } catch (e) { console.error("Error loading audios:", e) } } async function k() { const e = document.getElementById("audio-form"); document.getElementById("audio-container"), e.addEventListener("submit", async t => { t.preventDefault(); const o = document.getElementById("audio-file").files[0], a = document.getElementById("audio-title").value, n = document.getElementById("audio-codec").value; if (!o || !a || !n) return; const r = new FormData; r.append("file", o), r.append("title", a), r.append("codec", n); try { await U(o, n, a), e.reset(), await y() } catch (s) { console.error("Upload failed:", s), alert("Upload failed") } }), await y() } document.addEventListener(m.AudioUploaded, ({ detail: { id: e } }) => { y(), console.log("Audio uploaded:", e) }); document.addEventListener(m.AudioDeleted, ({ detail: { id: e } }) => { y(), console.log("Audio deleted:", e) }); function J() { const e = document.getElementById("program-file"), t = document.getElementById("program-upload-form"), o = document.getElementById("upload-programs-timeline-wrapper"), a = document.getElementById("upload-programs-timeline"); e.addEventListener("change", n => { const r = n.target.files[0]; if (!r) return; const s = new FileReader; s.onload = d => { const c = JSON.parse(d.target.result); w(a, c), o.classList.remove("hidden") }, s.readAsText(r) }), t.addEventListener("submit", async n => { n.preventDefault(); const r = e.files[0]; if (!r) { alert("Please select a program file."); return } const s = new FileReader; s.onload = async d => { try { const c = JSON.parse(d.target.result); await A(c), alert("Program uploaded successfully!") } catch (c) { alert("Failed to upload program: " + c.message) } }, s.readAsText(r) }) } document.addEventListener("DOMContentLoaded", async () => { const o = "MalmÃ¶ Skyttegille Rotation Target v0.4.1"; document.title = o, document.querySelector("#footer span").textContent = o, await M(); const a = document.getElementById("program-tab-button"), n = document.getElementById("audio-tab-button"), r = document.getElementById("upload-program-tab-button"), s = document.getElementById("program-section"), d = document.getElementById("audio-section"), c = document.getElementById("upload-program-section"); a.addEventListener("click", () => { a.classList.add("active"), n.classList.remove("active"), r.classList.remove("active"), s.classList.remove("hidden"), d.classList.add("hidden"), c.classList.add("hidden") }), n.addEventListener("click", async () => { n.classList.add("active"), a.classList.remove("active"), r.classList.remove("active"), d.classList.remove("hidden"), s.classList.add("hidden"), c.classList.add("hidden"), await k() }), r.addEventListener("click", () => { r.classList.add("active"), a.classList.remove("active"), n.classList.remove("active"), c.classList.remove("hidden"), s.classList.add("hidden"), d.classList.add("hidden"), J() }), q((i, l) => { console.log("SSE Event:", i, l); const u = new CustomEvent(i, { detail: l }); document.dispatchEvent(u) }) });
