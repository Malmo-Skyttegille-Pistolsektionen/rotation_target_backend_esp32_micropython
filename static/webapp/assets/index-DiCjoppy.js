(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}})();var B;const I=((B=window.APP_CONFIG)==null?void 0:B.SERVER_BASE_URL)||"http://localhost:8080",p=`${I}/api/v1`,x=`${I}/sse/v1`;async function T(){const e=await fetch(`${p}/programs`);return g(e)}async function O(e){const t=await fetch(`${p}/programs/${e}`);return g(t)}async function N(e){const t=await fetch(`${p}/programs`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return g(t)}async function R(e){const t=await fetch(`${p}/programs/${e}/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"}});return g(t)}async function D(e){const t=await fetch(`${p}/programs/${e}/load`,{method:"POST"});return g(t)}async function F(){const e=await fetch(`${p}/programs/start`,{method:"POST"});return g(e)}async function j(){const e=await fetch(`${p}/programs/stop`,{method:"POST"});return g(e)}async function M(e){const t=await fetch(`${p}/programs/series/${e}/skip_to`,{method:"POST",headers:{"Content-Type":"application/json"}});return g(t)}async function q(){const e=await fetch(`${p}/audios`);return g(e)}async function U(e,t,r){const o=new FormData;o.append("file",e),o.append("codec",t),o.append("title",r);const n=await fetch(`${p}/audios`,{method:"POST",body:o});return g(n)}async function k(e){const t=await fetch(`${p}/audios/${e}/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"}});return g(t)}async function J(){const e=await fetch(`${p}/targets/toggle`,{method:"POST"});return g(e)}async function g(e){if(console.log("Response status:",e.status,e.statusText),!e.ok)throw new Error("Request failed: ${response.statusText}");const t=e.headers.get("Content-Type");return t&&t.includes("application/json")?e.json():null}const u={ProgramAdded:"program_added",ProgramDeleted:"program_deleted",ProgramStarted:"program_started",ProgramCompleted:"program_completed",SeriesStarted:"series_started",SeriesCompleted:"series_completed",SeriesStopped:"series_stopped",SeriesNext:"series_next",EventStarted:"event_started",TargetStatus:"target_status",AudioAdded:"audio_added",AudioDeleted:"audio_deleted",Chrono:"chrono"};function V(e){const t=new EventSource(`${x}`,{withCredentials:!1});return Object.values(u).forEach(r=>{t.addEventListener(r,o=>{try{const n=JSON.parse(o.data);console.log("Received SSE event:",r,n),e(r,n)}catch(n){console.error("Failed to parse event:",r,n)}})}),t.onopen=()=>{console.log("SSE connection established")},t.onerror=r=>{console.error("SSE connection error:",r)},t}let z=[];function H(e){const t=z.find(r=>r.id===e);return t?t.title:`Audio ${e}`}async function v(){try{const e=document.getElementById("audio-container"),{audios:t=[]}=await q();if(e.innerHTML="",t.length>0){const r=document.createElement("ul");t.slice().sort((o,n)=>o.id-n.id).forEach(o=>{const n=document.createElement("li");if(n.textContent=`${o.id}: ${o.title}`,!o.readonly){const a=document.createElement("button");a.textContent="Delete",a.classList.add("delete-btn"),a.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${o.title}"?`))try{await k(o.id),alert(`Audio "${o.title}" deleted successfully.`),await v()}catch(s){console.error("Failed to delete audio:",s),alert("Failed to delete audio.")}}),n.appendChild(a)}r.appendChild(n)}),e.appendChild(r)}}catch(e){console.error("Error loading audios:",e)}}async function W(){const e=document.getElementById("audio-file"),t=document.getElementById("audio-title");e.addEventListener("change",()=>{const o=e.files[0];if(o){const n=o.name.lastIndexOf("."),a=n>0?o.name.substring(0,n):o.name;t.value=a}});const r=document.getElementById("audio-form");document.getElementById("audio-container"),r.addEventListener("submit",async o=>{o.preventDefault();const n=document.getElementById("audio-file").files[0],a=document.getElementById("audio-title").value,s=document.getElementById("audio-codec").value;if(console.debug("Form submit:",{file:n,title:a,codec:s}),!n||!a||!s){console.debug("Missing required fields",{file:n,title:a,codec:s});return}try{await U(n,s,a),console.debug("Upload successful"),r.reset(),await v()}catch(d){console.error("Upload failed:",d),alert("Upload failed")}}),await v()}document.addEventListener(u.AudioAdded,async({detail:{id:e}})=>{v(),console.log("Audio added:",e)});document.addEventListener(u.AudioDeleted,async({detail:{id:e}})=>{v(),console.log("Audio deleted:",e)});let C=null;function P(e,t){e.innerHTML="",C=G(t.series),C.forEach((r,o)=>{const n=document.createElement("div");n.className="series",r.optional&&n.classList.add("optional"),n.dataset.seriesIndex=o;const a=document.createElement("div");a.textContent=r.name+(r.optional?" (optional)":""),n.appendChild(a);const s=document.createElement("div");s.className="events",r.events.forEach((d,c)=>{const l=document.createElement("div");l.className=`event ${d.symbolClass}`,l.dataset.eventIndex=c;const i=document.createElement("div");i.className="dur",i.textContent=Math.trunc(d.duration/1e3),l.appendChild(i);const m=document.createElement("div");m.className="symbol",m.textContent=d.symbolText,l.appendChild(m);const f=document.createElement("div");if(f.className="acc",f.textContent=Math.trunc(d.acc/1e3),l.appendChild(f),d.audio_ids&&d.audio_ids.length>0){const E=d.audio_ids.map(H).join(", ");l.setAttribute("title",E)}s.appendChild(l)}),n.appendChild(s),e.appendChild(n)})}function G(e){return e.map(t=>{let r=0;const o=t.events.map(n=>{const a=n.duration;let s="no-action",d="";n.command==="show"&&n.audio_ids?(s="show audio",d="A"):n.command==="hide"&&n.audio_ids?(s="hide audio",d="A"):n.command==="show"?s="show":n.command==="hide"?s="hide":n.audio_ids&&(s="audio",d="A");const c={...n,duration:a,acc:r,symbolClass:s,symbolText:d};return r+=a,c});return{...t,events:o}})}function L(e,t){document.querySelectorAll(".series").forEach(o=>o.classList.remove("current")),document.querySelectorAll(".event").forEach(o=>o.classList.remove("current"));const r=document.querySelector(`[data-series-index='${e}']`);if(r){r.classList.add("current");const o=r.querySelector(`[data-event-index='${t}']`);o&&o.classList.add("current")}}function K(){document.querySelectorAll(".series").forEach(e=>e.classList.remove("current")),document.querySelectorAll(".event").forEach(e=>e.classList.remove("current"))}const A={program_id:null,running_series_start:null,current_series_index:null,current_event_index:null,target_status_shown:!1};function h(e){Object.assign(A,e)}function y(){const e=document.getElementById("start-btn"),t=document.getElementById("stop-btn"),{program_id:r,running_series_start:o}=A;r!==null&&o===null?(e.classList.remove("hidden"),t.classList.add("hidden")):o!==null?(e.classList.add("hidden"),t.classList.remove("hidden")):(e.classList.add("hidden"),t.classList.add("hidden"))}async function w(){const e=document.getElementById("choose-program"),t=document.getElementById("choose-serie"),r=document.getElementById("show-json"),o=document.getElementById("run-timeline-wrapper"),n=document.getElementById("run-program-timeline"),a=document.getElementById("start-btn"),s=document.getElementById("stop-btn"),d=document.getElementById("toggle-btn");document.getElementById("chrono");try{const c=await T();console.log("Fetched programs:",c),e.innerHTML="";const l=document.createElement("option");l.disabled=!0,l.selected=!0,l.textContent="Choose program",e.appendChild(l),c.forEach(i=>{const m=document.createElement("option");m.value=i.id,m.textContent=i.title,e.appendChild(m)}),e.addEventListener("change",async()=>{const i=parseInt(e.value,10);if(!isNaN(i)){const m=e.querySelector("option[disabled]");m&&m.remove(),await D(i);try{const f=await O(i);window.currentProgram=f,P(n,f),L(0,0),h({program_id:i,running_series_start:null}),y(),t.innerHTML="";const E=document.createElement("option");E.disabled=!0,E.selected=!0,E.textContent="Choose a series",t.appendChild(E),f.series.forEach((b,$)=>{const _=document.createElement("option");_.value=$,_.textContent=b.name+(b.optional?" (optional)":""),t.appendChild(_)}),t.classList.remove("hidden"),r.classList.remove("hidden"),o.classList.remove("hidden"),a.disabled=!1,s.disabled=!1}catch(f){console.error("Failed to fetch program by ID:",f)}}}),t.addEventListener("change",async()=>{const i=parseInt(t.value,10);isNaN(i)||M(i)}),r.addEventListener("click",()=>{if(window.currentProgram){const i=JSON.stringify(window.currentProgram,null,2),m=new Blob([i],{type:"application/json"}),f=URL.createObjectURL(m);window.open(f,"_blank")}}),a.addEventListener("click",async()=>{await F()}),s.addEventListener("click",async()=>{await j()}),d.addEventListener("click",async()=>{await J()})}catch(c){console.error("Failed to initialize Run tab:",c)}}document.addEventListener(u.ProgramCompleted,({detail:{program_id:e}})=>{h({program_id:null,running_series_start:null}),K(),y()});document.addEventListener(u.SeriesStarted,({detail:{program_id:e,series_index:t}})=>{h({program_id:e,running_series_start:new Date,current_series_index:t,current_event_index:0}),L(t,0),document.getElementById("chrono").classList.remove("hidden"),y()});document.addEventListener(u.SeriesCompleted,({detail:{program_id:e}})=>{h({running_series_start:null}),document.getElementById("chrono").classList.add("hidden"),y()});document.addEventListener(u.SeriesStopped,({detail:{program_id:e,series_index:t,event_index:r}})=>{h({program_id:e,running_series_start:null,current_series_index:t,current_event_index:r}),L(t,r),document.getElementById("chrono").classList.add("hidden"),y()});document.addEventListener(u.SeriesNext,({detail:{program_id:e,series_index:t}})=>{h({program_id:e,current_series_index:t,current_event_index:0}),L(t,0),y()});document.addEventListener(u.EventStarted,({detail:{program_id:e,series_index:t,event_index:r}})=>{h({program_id:e,current_series_index:t,current_event_index:r}),L(t,r)});document.addEventListener(u.TargetStatus,({detail:{status:e}})=>{h({target_status_shown:e==="shown"})});document.addEventListener(u.Chrono,({detail:{elapsed:e}})=>{const t=document.getElementById("chrono");t&&(t.textContent=`${Math.floor(e/1e3)}s`)});document.addEventListener(u.ProgramAdded,({detail:{program_id:e}})=>{w()});document.addEventListener(u.ProgramDeleted,({detail:{program_id:e}})=>{w()});async function S(){try{const e=document.getElementById("programs-container"),t=await T();if(e.innerHTML="",t.length>0){const r=document.createElement("ul");t.slice().sort((o,n)=>o.id-n.id).forEach(o=>{const n=document.createElement("li");if(n.textContent=`${o.id}: ${o.title}`,!o.readonly){const a=document.createElement("button");a.textContent="Delete",a.classList.add("delete-btn"),a.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${o.title}"?`))try{await R(o.id),alert(`Program "${o.title}" deleted successfully.`),await S()}catch(s){console.error("Failed to delete program:",s),alert("Failed to delete program.")}}),n.appendChild(a)}r.appendChild(n)}),e.appendChild(r)}}catch(e){console.error("Error loading programs:",e)}}async function Q(){const e=document.getElementById("program-file"),t=document.getElementById("program-upload-form"),r=document.getElementById("upload-programs-timeline-wrapper"),o=document.getElementById("upload-programs-timeline");e.addEventListener("change",n=>{const a=n.target.files[0];if(!a)return;const s=new FileReader;s.onload=d=>{const c=JSON.parse(d.target.result);P(o,c),r.classList.remove("hidden")},s.readAsText(a)}),t.addEventListener("submit",async n=>{n.preventDefault();const a=e.files[0];if(!a){alert("Please select a program file.");return}const s=new FileReader;s.onload=async d=>{try{const c=JSON.parse(d.target.result);await N(c),alert("Program uploaded successfully!")}catch(c){alert("Failed to upload program: "+c.message)}},s.readAsText(a)}),await S()}document.addEventListener(u.ProgramAdded,async({detail:{id:e}})=>{await S(),console.log("Program added:",e)});document.addEventListener(u.ProgramDeleted,async({detail:{id:e}})=>{await S(),console.log("Program deleted:",e)});document.addEventListener("DOMContentLoaded",async()=>{const r="MalmÃ¶ Skyttegille Rotation Target v0.4.1";document.title=r,document.querySelector("#footer span").textContent=r,await w();const o=document.getElementById("run-tab-button"),n=document.getElementById("audio-tab-button"),a=document.getElementById("programs-tab-button"),s=document.getElementById("run-section"),d=document.getElementById("audio-section"),c=document.getElementById("programs-section");o.addEventListener("click",async()=>{o.classList.add("active"),n.classList.remove("active"),a.classList.remove("active"),s.classList.remove("hidden"),d.classList.add("hidden"),c.classList.add("hidden"),await w()}),n.addEventListener("click",async()=>{n.classList.add("active"),o.classList.remove("active"),a.classList.remove("active"),d.classList.remove("hidden"),s.classList.add("hidden"),c.classList.add("hidden"),await W()}),a.addEventListener("click",()=>{a.classList.add("active"),o.classList.remove("active"),n.classList.remove("active"),c.classList.remove("hidden"),s.classList.add("hidden"),d.classList.add("hidden"),Q()}),V((l,i)=>{console.log("SSE Event:",l,i);const m=new CustomEvent(l,{detail:i});document.dispatchEvent(m)})});
