(function () { const t = document.createElement("link").relList; if (t && t.supports && t.supports("modulepreload")) return; for (const n of document.querySelectorAll('link[rel="modulepreload"]')) o(n); new MutationObserver(n => { for (const a of n) if (a.type === "childList") for (const s of a.addedNodes) s.tagName === "LINK" && s.rel === "modulepreload" && o(s) }).observe(document, { childList: !0, subtree: !0 }); function r(n) { const a = {}; return n.integrity && (a.integrity = n.integrity), n.referrerPolicy && (a.referrerPolicy = n.referrerPolicy), n.crossOrigin === "use-credentials" ? a.credentials = "include" : n.crossOrigin === "anonymous" ? a.credentials = "omit" : a.credentials = "same-origin", a } function o(n) { if (n.ep) return; n.ep = !0; const a = r(n); fetch(n.href, a) } })(); let _ = null; function C(e, t) { e.innerHTML = "", _ = T(t.series), _.forEach((r, o) => { const n = document.createElement("div"); n.className = "series", r.optional && n.classList.add("optional"), n.dataset.seriesIndex = o; const a = document.createElement("div"); a.textContent = r.name + (r.optional ? " (optional)" : ""), n.appendChild(a); const s = document.createElement("div"); s.className = "events", r.events.forEach((d, c) => { const i = document.createElement("div"); i.className = `event ${d.symbolClass}`, i.dataset.eventIndex = c; const l = document.createElement("div"); l.className = "dur", l.textContent = d.duration, i.appendChild(l); const u = document.createElement("div"); u.className = "symbol", u.textContent = d.symbolText, i.appendChild(u); const f = document.createElement("div"); f.className = "acc", f.textContent = d.acc, i.appendChild(f), s.appendChild(i) }), n.appendChild(s), e.appendChild(n) }) } function T(e) { return e.map(t => { let r = 0; const o = t.events.map(n => { const a = n.duration; let s = "no-action", d = ""; n.command === "show" && n.audio_ids ? (s = "show audio", d = "A") : n.command === "hide" && n.audio_ids ? (s = "hide audio", d = "A") : n.command === "show" ? s = "show" : n.command === "hide" ? s = "hide" : n.audio_ids && (s = "audio", d = "A"); const c = { ...n, duration: a, acc: r, symbolClass: s, symbolText: d }; return r += a, c }); return { ...t, events: o } }) } function v(e, t) { document.querySelectorAll(".series").forEach(o => o.classList.remove("current")), document.querySelectorAll(".event").forEach(o => o.classList.remove("current")); const r = document.querySelector(`[data-series-index='${e}']`); if (r) { r.classList.add("current"); const o = r.querySelector(`[data-event-index='${t}']`); o && o.classList.add("current") } } function x() { document.querySelectorAll(".series").forEach(e => e.classList.remove("current")), document.querySelectorAll(".event").forEach(e => e.classList.remove("current")) } const b = "http://192.168.1.71:8080", p = `${b}/api/v1`, $ = `${b}/sse/v1`; async function B() { const e = await fetch(`${p}/programs`); return g(e) } async function A(e) { const t = await fetch(`${p}/programs/${e}`); return g(t) } async function O(e) { const t = await fetch(`${p}/programs`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(e) }); return g(t) } async function N(e) { const t = await fetch(`${p}/programs/${e}/delete`, { method: "DELETE", headers: { "Content-Type": "application/json" } }); return g(t) } async function D(e) { const t = await fetch(`${p}/programs/${e}/load`, { method: "POST" }); return g(t) } async function F() { const e = await fetch(`${p}/programs/start`, { method: "POST" }); return g(e) } async function R() { const e = await fetch(`${p}/programs/stop`, { method: "POST" }); return g(e) } async function j(e) { const t = await fetch(`${p}/programs/series/${e}/skip_to`, { method: "POST", headers: { "Content-Type": "application/json" } }); return g(t) } async function q() { const e = await fetch(`${p}/audios`); return g(e) } async function M(e, t, r) { const o = new FormData; o.append("file", e), o.append("codec", t), o.append("title", r); const n = await fetch(`${p}/audios`, { method: "POST", body: o }); return g(n) } async function U(e) { const t = await fetch(`${p}/audios/${e}/delete`, { method: "DELETE", headers: { "Content-Type": "application/json" } }); return g(t) } async function g(e) { if (console.log("Response status:", e.status, e.statusText), !e.ok) throw new Error("Request failed: ${response.statusText}"); const t = e.headers.get("Content-Type"); return t && t.includes("application/json") ? e.json() : null } const m = { ProgramAdded: "program_added", ProgramDeleted: "program_deleted", ProgramStarted: "program_started", ProgramCompleted: "program_completed", SeriesStarted: "series_started", SeriesCompleted: "series_completed", SeriesStopped: "series_stopped", SeriesNext: "series_next", EventStarted: "event_started", TargetStatus: "target_status", AudioAdded: "audio_added", AudioDeleted: "audio_deleted", Chrono: "chrono" }; function k(e) { const t = new EventSource(`${$}`, { withCredentials: !1 }); return Object.values(m).forEach(r => { t.addEventListener(r, o => { try { const n = JSON.parse(o.data); console.log("Received SSE event:", r, n), e(r, n) } catch (n) { console.error("Failed to parse event:", r, n) } }) }), t.onopen = () => { console.log("SSE connection established") }, t.onerror = r => { console.error("SSE connection error:", r) }, t } const I = { program_id: null, running_series_start: null, current_series_index: null, current_event_index: null, target_status_shown: !1 }; function h(e) { Object.assign(I, e) } function E() { const e = document.getElementById("start-btn"), t = document.getElementById("stop-btn"), { program_id: r, running_series_start: o } = I; r !== null && o === null ? (e.classList.remove("hidden"), t.classList.add("hidden")) : o !== null ? (e.classList.add("hidden"), t.classList.remove("hidden")) : (e.classList.add("hidden"), t.classList.add("hidden")) } async function J() { const e = document.getElementById("choose-program"), t = document.getElementById("choose-serie"), r = document.getElementById("show-json"), o = document.getElementById("programs-timeline-wrapper"), n = document.getElementById("programs-timeline"), a = document.getElementById("start-btn"), s = document.getElementById("stop-btn"); document.getElementById("chrono"); try { const d = await B(); console.log("Fetched programs:", d), e.innerHTML = ""; const c = document.createElement("option"); c.disabled = !0, c.selected = !0, c.textContent = "Choose program", e.appendChild(c), d.forEach(i => { const l = document.createElement("option"); l.value = i.id, l.textContent = i.title, e.appendChild(l) }), e.addEventListener("change", async () => { const i = parseInt(e.value, 10); if (!isNaN(i)) { const l = e.querySelector("option[disabled]"); l && l.remove(), await D(i); try { const u = await A(i); window.currentProgram = u, C(n, u), v(0, 0), h({ program_id: i, running_series_start: null }), E(), t.innerHTML = ""; const f = document.createElement("option"); f.disabled = !0, f.selected = !0, f.textContent = "Choose a series", t.appendChild(f), u.series.forEach((S, P) => { const w = document.createElement("option"); w.value = P, w.textContent = S.name + (S.optional ? " (optional)" : ""), t.appendChild(w) }), t.classList.remove("hidden"), r.classList.remove("hidden"), o.classList.remove("hidden"), a.disabled = !1, s.disabled = !1 } catch (u) { console.error("Failed to fetch program by ID:", u) } } }), t.addEventListener("change", async () => { const i = parseInt(t.value, 10); isNaN(i) || j(i) }), r.addEventListener("click", () => { if (window.currentProgram) { const i = JSON.stringify(window.currentProgram, null, 2), l = new Blob([i], { type: "application/json" }), u = URL.createObjectURL(l); window.open(u, "_blank") } }), a.addEventListener("click", async () => { await F() }), s.addEventListener("click", async () => { await R() }) } catch (d) { console.error("Failed to initialize Programs tab:", d) } } document.addEventListener(m.ProgramCompleted, ({ detail: { program_id: e } }) => { h({ program_id: null, running_series_start: null }), x(), E() }); document.addEventListener(m.SeriesStarted, ({ detail: { program_id: e, series_index: t } }) => { h({ program_id: e, running_series_start: new Date, current_series_index: t, current_event_index: 0 }), v(t, 0), document.getElementById("chrono").classList.remove("hidden"), E() }); document.addEventListener(m.SeriesCompleted, ({ detail: { program_id: e } }) => { h({ running_series_start: null }), document.getElementById("chrono").classList.add("hidden"), E() }); document.addEventListener(m.SeriesStopped, ({ detail: { program_id: e, series_index: t, event_index: r } }) => { h({ program_id: e, running_series_start: null, current_series_index: t, current_event_index: r }), v(t, r), document.getElementById("chrono").classList.add("hidden"), E() }); document.addEventListener(m.SeriesNext, ({ detail: { program_id: e, series_index: t } }) => { h({ program_id: e, current_series_index: t, current_event_index: 0 }), v(t, 0), E() }); document.addEventListener(m.EventStarted, ({ detail: { program_id: e, series_index: t, event_index: r } }) => { h({ program_id: e, current_series_index: t, current_event_index: r }), v(t, r) }); document.addEventListener(m.TargetStatus, ({ detail: { status: e } }) => { h({ target_status_shown: e === "shown" }) }); document.addEventListener(m.Chrono, ({ detail: { elapsed: e } }) => { const t = document.getElementById("chrono"); t && (t.textContent = `${Math.floor(e / 1e3)}s`) }); async function y() { try { const e = document.getElementById("audio-container"), { audios: t = [] } = await q(); if (e.innerHTML = "", t.length > 0) { const r = document.createElement("ul"); t.slice().sort((o, n) => o.id - n.id).forEach(o => { const n = document.createElement("li"); if (n.textContent = `${o.id}: ${o.title}`, !o.readonly) { const a = document.createElement("button"); a.textContent = "Delete", a.classList.add("delete-btn"), a.addEventListener("click", async () => { if (confirm(`Are you sure you want to delete "${o.title}"?`)) try { await U(o.id), alert(`Audio "${o.title}" deleted successfully.`), await y() } catch (s) { console.error("Failed to delete audio:", s), alert("Failed to delete audio.") } }), n.appendChild(a) } r.appendChild(n) }), e.appendChild(r) } } catch (e) { console.error("Error loading audios:", e) } } async function V() { const e = document.getElementById("audio-file"), t = document.getElementById("audio-title"); e.addEventListener("change", () => { const o = e.files[0]; if (o) { const n = o.name.lastIndexOf("."), a = n > 0 ? o.name.substring(0, n) : o.name; t.value = a } }); const r = document.getElementById("audio-form"); document.getElementById("audio-container"), r.addEventListener("submit", async o => { o.preventDefault(); const n = document.getElementById("audio-file").files[0], a = document.getElementById("audio-title").value, s = document.getElementById("audio-codec").value; if (console.debug("Form submit:", { file: n, title: a, codec: s }), !n || !a || !s) { console.debug("Missing required fields", { file: n, title: a, codec: s }); return } try { await M(n, s, a), console.debug("Upload successful"), r.reset(), await y() } catch (d) { console.error("Upload failed:", d), alert("Upload failed") } }), await y() } document.addEventListener(m.AudioAdded, async ({ detail: { id: e } }) => { y(), console.log("Audio added:", e) }); document.addEventListener(m.AudioDeleted, async ({ detail: { id: e } }) => { y(), console.log("Audio deleted:", e) }); async function L() { try { const e = document.getElementById("programs-container"), t = await B(); if (e.innerHTML = "", t.length > 0) { const r = document.createElement("ul"); t.slice().sort((o, n) => o.id - n.id).forEach(o => { const n = document.createElement("li"); if (n.textContent = `${o.id}: ${o.title}`, !o.readonly) { const a = document.createElement("button"); a.textContent = "Delete", a.classList.add("delete-btn"), a.addEventListener("click", async () => { if (confirm(`Are you sure you want to delete "${o.title}"?`)) try { await N(o.id), alert(`Program "${o.title}" deleted successfully.`), await L() } catch (s) { console.error("Failed to delete program:", s), alert("Failed to delete program.") } }), n.appendChild(a) } r.appendChild(n) }), e.appendChild(r) } } catch (e) { console.error("Error loading programs:", e) } } async function z() { const e = document.getElementById("program-file"), t = document.getElementById("program-upload-form"), r = document.getElementById("upload-programs-timeline-wrapper"), o = document.getElementById("upload-programs-timeline"); e.addEventListener("change", n => { const a = n.target.files[0]; if (!a) return; const s = new FileReader; s.onload = d => { const c = JSON.parse(d.target.result); C(o, c), r.classList.remove("hidden") }, s.readAsText(a) }), t.addEventListener("submit", async n => { n.preventDefault(); const a = e.files[0]; if (!a) { alert("Please select a program file."); return } const s = new FileReader; s.onload = async d => { try { const c = JSON.parse(d.target.result); await O(c), alert("Program uploaded successfully!") } catch (c) { alert("Failed to upload program: " + c.message) } }, s.readAsText(a) }), await L() } document.addEventListener(m.ProgramAdded, async ({ detail: { id: e } }) => { await L(), console.log("Program added:", e) }); document.addEventListener(m.ProgramDeleted, async ({ detail: { id: e } }) => { await L(), console.log("Program deleted:", e) }); document.addEventListener("DOMContentLoaded", async () => { const r = "MalmÃ¶ Skyttegille Rotation Target v0.4.1"; document.title = r, document.querySelector("#footer span").textContent = r, await J(); const o = document.getElementById("program-tab-button"), n = document.getElementById("audio-tab-button"), a = document.getElementById("upload-program-tab-button"), s = document.getElementById("program-section"), d = document.getElementById("audio-section"), c = document.getElementById("upload-program-section"); o.addEventListener("click", () => { o.classList.add("active"), n.classList.remove("active"), a.classList.remove("active"), s.classList.remove("hidden"), d.classList.add("hidden"), c.classList.add("hidden") }), n.addEventListener("click", async () => { n.classList.add("active"), o.classList.remove("active"), a.classList.remove("active"), d.classList.remove("hidden"), s.classList.add("hidden"), c.classList.add("hidden"), await V() }), a.addEventListener("click", () => { a.classList.add("active"), o.classList.remove("active"), n.classList.remove("active"), c.classList.remove("hidden"), s.classList.add("hidden"), d.classList.add("hidden"), z() }), k((i, l) => { console.log("SSE Event:", i, l); const u = new CustomEvent(i, { detail: l }); document.dispatchEvent(u) }) });
