(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function a(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=a(n);fetch(n.href,r)}})();const m={ProgramAdded:"program_added",ProgramDeleted:"program_deleted",ProgramStarted:"program_started",ProgramCompleted:"program_completed",SeriesStarted:"series_started",SeriesCompleted:"series_completed",SeriesStopped:"series_stopped",SeriesNext:"series_next",EventStarted:"event_started",TargetStatus:"target_status",AudioAdded:"audio_added",AudioDeleted:"audio_deleted",Chrono:"chrono",AdminModeStatus:"admin_mode_status"};let E=null;function A(e){return E&&E.close(),E=new EventSource(x,{withCredentials:!1}),Object.values(m).forEach(t=>{E.addEventListener(t,a=>{try{const o=JSON.parse(a.data);console.log("Received SSE event:",t,o),e(t,o)}catch(o){console.error("Failed to parse event:",t,o)}})}),E.onopen=()=>{console.log("SSE connection established")},E.onerror=t=>{console.error("SSE connection error:",t)},E}const D=()=>localStorage.getItem("SERVER_BASE_URL")||"http://localhost:8080";let L=D(),u=`${L}/api/v1`,x=`${L}/sse/v1`,b=localStorage.getItem("ADMIN_BEARER_TOKEN")||null;function M(e){L=e,u=`${L}/api/v1`,x=`${L}/sse/v1`,localStorage.setItem("SERVER_BASE_URL",e),typeof A=="function"&&(E&&E.close(),A())}function $(){const e=document.getElementById("settings-form"),t=document.getElementById("server-base-url"),a=document.getElementById("settings-status"),o=document.getElementById("admin-enable-form"),n=document.getElementById("admin-disable-form"),r=document.getElementById("admin-password"),s=document.getElementById("admin-mode-status");t.value=L,e.onsubmit=i=>{i.preventDefault();const c=t.value.trim();if(!c||!F(c)){a.textContent="Please enter a valid URL.",a.style.color="red";return}M(c),a.textContent="Server Base URL updated!",a.style.color="green",d()},o.onsubmit=async i=>{i.preventDefault();const c=r.value;s.textContent="";try{b=(await Q(c)).token,localStorage.setItem("ADMIN_BEARER_TOKEN",b),r.value="",s.textContent="Admin mode enabled!",s.style.color="green",d()}catch{s.textContent="Failed to enable admin mode.",s.style.color="red"}},n.onsubmit=async i=>{i.preventDefault(),s.textContent="";try{await X(b),b=null,localStorage.removeItem("ADMIN_BEARER_TOKEN"),s.textContent="Admin mode disabled!",s.style.color="green",d()}catch{s.textContent="Failed to disable admin mode.",s.style.color="red"}};async function d(){try{const{enabled:i}=await G();i?b?(o.classList.add("hidden"),n.classList.remove("hidden"),s.textContent="Admin mode is enabled.",s.style.color="green"):(o.classList.add("hidden"),n.classList.add("hidden"),s.textContent="Admin mode is enabled (by another client).",s.style.color="orange"):(o.classList.remove("hidden"),n.classList.add("hidden"),s.textContent="Admin mode is disabled.",s.style.color="gray")}catch{s.textContent="Could not fetch admin mode status.",s.style.color="red"}}$.updateAdminModeUI=d,d()}function F(e){try{const t=new URL(e);return/^https?:$/.test(t.protocol)&&(/^[a-zA-Z0-9.-]+$/.test(t.hostname)||/^(\d{1,3}\.){3}\d{1,3}$/.test(t.hostname))?/^(\d{1,3}\.){3}\d{1,3}$/.test(t.hostname)?t.hostname.split(".").every(a=>{const o=Number(a);return o>=0&&o<=255}):!0:!1}catch{return!1}}async function P(){const e=await fetch(`${u}/programs`);return p(e)}async function U(e){const t=await fetch(`${u}/programs/${e}`);return p(t)}async function j(e){const t=await f(`${u}/programs`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return p(t)}async function k(e){const t=await f(`${u}/programs/${e}/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"}});return p(t)}async function q(e){const t=await f(`${u}/programs/${e}/load`,{method:"POST"});return p(t)}async function J(){const e=await f(`${u}/programs/start`,{method:"POST"});return p(e)}async function V(){const e=await f(`${u}/programs/stop`,{method:"POST"});return p(e)}async function z(e){const t=await f(`${u}/programs/series/${e}/skip_to`,{method:"POST",headers:{"Content-Type":"application/json"}});return p(t)}async function K(){const e=await fetch(`${u}/audios`);return p(e)}async function H(e,t,a){const o=new FormData;o.append("file",e),o.append("codec",t),o.append("title",a);const n=await f(`${u}/audios`,{method:"POST",body:o});return p(n)}async function W(e){const t=await f(`${u}/audios/${e}/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"}});return p(t)}async function Z(){const e=await f(`${u}/targets/toggle`,{method:"POST"});return p(e)}async function G(){const e=await fetch(`${u}/admin-mode/status`);return p(e)}async function Q(e){const t=await fetch(`${u}/admin-mode/enable`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:e})});return p(t)}async function X(){const e=await f(`${u}/admin-mode/disable`,{method:"POST"});return p(e)}async function p(e){if(console.log("Response status:",e.status,e.statusText),!e.ok)throw new Error(`Request failed: ${e.statusText}`);const t=e.headers.get("Content-Type");return t&&t.includes("application/json")?e.json():null}async function f(e,t={}){const a=localStorage.getItem("ADMIN_BEARER_TOKEN");return t.headers=t.headers||{},a&&(t.headers.Authorization=`Bearer ${a}`),fetch(e,t)}let Y=[];function ee(e){const t=Y.find(a=>a.id===e);return t?t.title:`Audio ${e}`}async function _(){try{const e=document.getElementById("audio-container"),{audios:t=[]}=await K();if(e.innerHTML="",t.length>0){const a=document.createElement("ul");t.slice().sort((o,n)=>o.id-n.id).forEach(o=>{const n=document.createElement("li");if(n.textContent=`${o.id}: ${o.title}`,!o.readonly){const r=document.createElement("button");r.textContent="Delete",r.classList.add("delete-btn"),r.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${o.title}"?`))try{await W(o.id),alert(`Audio "${o.title}" deleted successfully.`),await _()}catch(s){console.error("Failed to delete audio:",s),alert("Failed to delete audio.")}}),n.appendChild(r)}a.appendChild(n)}),e.appendChild(a)}}catch(e){console.error("Error loading audios:",e)}}async function te(){const e=document.getElementById("audio-file"),t=document.getElementById("audio-title");e.addEventListener("change",()=>{const o=e.files[0];if(o){const n=o.name.lastIndexOf("."),r=n>0?o.name.substring(0,n):o.name;t.value=r}});const a=document.getElementById("audio-form");document.getElementById("audio-container"),a.addEventListener("submit",async o=>{o.preventDefault();const n=document.getElementById("audio-file").files[0],r=document.getElementById("audio-title").value,s=document.getElementById("audio-codec").value;if(console.debug("Form submit:",{file:n,title:r,codec:s}),!n||!r||!s){console.debug("Missing required fields",{file:n,title:r,codec:s});return}try{await H(n,s,r),console.debug("Upload successful"),a.reset(),await _()}catch(d){console.error("Upload failed:",d),alert("Upload failed")}}),await _()}document.addEventListener(m.AudioAdded,async({detail:{id:e}})=>{_(),console.log("Audio added:",e)});document.addEventListener(m.AudioDeleted,async({detail:{id:e}})=>{_(),console.log("Audio deleted:",e)});let T=null;function R(e,t){e.innerHTML="",T=ne(t.series),T.forEach((a,o)=>{const n=document.createElement("div");n.className="series",a.optional&&n.classList.add("optional"),n.dataset.seriesIndex=o;const r=document.createElement("div");r.textContent=a.name+(a.optional?" (optional)":""),n.appendChild(r);const s=document.createElement("div");s.className="events",a.events.forEach((d,i)=>{const c=document.createElement("div");c.className=`event ${d.symbolClass}`,c.dataset.eventIndex=i;const l=document.createElement("div");l.className="dur",l.textContent=Math.trunc(d.duration/1e3),c.appendChild(l);const g=document.createElement("div");g.className="symbol",g.textContent=d.symbolText,c.appendChild(g);const h=document.createElement("div");if(h.className="acc",h.textContent=Math.trunc(d.acc/1e3),c.appendChild(h),d.audio_ids&&d.audio_ids.length>0){const v=d.audio_ids.map(ee).join(", ");c.setAttribute("title",v)}s.appendChild(c)}),n.appendChild(s),e.appendChild(n)})}function ne(e){return e.map(t=>{let a=0;const o=t.events.map(n=>{const r=n.duration;let s="no-action",d="";n.command==="show"&&n.audio_ids?(s="show audio",d="A"):n.command==="hide"&&n.audio_ids?(s="hide audio",d="A"):n.command==="show"?s="show":n.command==="hide"?s="hide":n.audio_ids&&(s="audio",d="A");const i={...n,duration:r,acc:a,symbolClass:s,symbolText:d};return a+=r,i});return{...t,events:o}})}function w(e,t){document.querySelectorAll(".series").forEach(o=>o.classList.remove("current")),document.querySelectorAll(".event").forEach(o=>o.classList.remove("current"));const a=document.querySelector(`[data-series-index='${e}']`);if(a){a.classList.add("current");const o=a.querySelector(`[data-event-index='${t}']`);o&&o.classList.add("current")}}function oe(){document.querySelectorAll(".series").forEach(e=>e.classList.remove("current")),document.querySelectorAll(".event").forEach(e=>e.classList.remove("current"))}const O={program_id:null,running_series_start:null,current_series_index:null,current_event_index:null,target_status_shown:!1};function y(e){Object.assign(O,e)}function S(){const e=document.getElementById("start-btn"),t=document.getElementById("stop-btn"),{program_id:a,running_series_start:o}=O;a!==null&&o===null?(e.classList.remove("hidden"),t.classList.add("hidden")):o!==null?(e.classList.add("hidden"),t.classList.remove("hidden")):(e.classList.add("hidden"),t.classList.add("hidden"))}async function C(){const e=document.getElementById("choose-program"),t=document.getElementById("choose-serie"),a=document.getElementById("run-timeline-wrapper"),o=document.getElementById("run-program-timeline"),n=document.getElementById("start-btn"),r=document.getElementById("stop-btn"),s=document.getElementById("toggle-btn");document.getElementById("chrono");try{const d=await P();console.log("Fetched programs:",d),e.innerHTML="";const i=document.createElement("option");i.disabled=!0,i.selected=!0,i.textContent="Choose program",e.appendChild(i),d.forEach(c=>{const l=document.createElement("option");l.value=c.id,l.textContent=c.title,e.appendChild(l)}),e.addEventListener("change",async()=>{const c=parseInt(e.value,10);if(!isNaN(c)){const l=e.querySelector("option[disabled]");l&&l.remove(),await q(c);try{const g=await U(c);window.currentProgram=g,R(o,g),w(0,0),y({program_id:c,running_series_start:null}),S(),t.innerHTML="";const h=document.createElement("option");h.disabled=!0,h.selected=!0,h.textContent="Choose a series",t.appendChild(h),g.series.forEach((v,N)=>{const I=document.createElement("option");I.value=N,I.textContent=v.name+(v.optional?" (optional)":""),t.appendChild(I)}),t.classList.remove("hidden"),a.classList.remove("hidden"),n.disabled=!1,r.disabled=!1}catch(g){console.error("Failed to fetch program by ID:",g)}}}),t.addEventListener("change",async()=>{const c=parseInt(t.value,10);isNaN(c)||z(c)}),n.addEventListener("click",async()=>{await J()}),r.addEventListener("click",async()=>{await V()}),s.addEventListener("click",async()=>{await Z()})}catch(d){console.error("Failed to initialize Run tab:",d)}}document.addEventListener(m.ProgramCompleted,({detail:{program_id:e}})=>{y({program_id:null,running_series_start:null}),oe(),S()});document.addEventListener(m.SeriesStarted,({detail:{program_id:e,series_index:t}})=>{y({program_id:e,running_series_start:new Date,current_series_index:t,current_event_index:0}),w(t,0),document.getElementById("chrono").classList.remove("hidden"),S()});document.addEventListener(m.SeriesCompleted,({detail:{program_id:e}})=>{y({running_series_start:null}),document.getElementById("chrono").classList.add("hidden"),S()});document.addEventListener(m.SeriesStopped,({detail:{program_id:e,series_index:t,event_index:a}})=>{y({program_id:e,running_series_start:null,current_series_index:t,current_event_index:a}),w(t,a),document.getElementById("chrono").classList.add("hidden"),S()});document.addEventListener(m.SeriesNext,({detail:{program_id:e,series_index:t}})=>{y({program_id:e,current_series_index:t,current_event_index:0}),w(t,0),S()});document.addEventListener(m.EventStarted,({detail:{program_id:e,series_index:t,event_index:a}})=>{y({program_id:e,current_series_index:t,current_event_index:a}),w(t,a)});document.addEventListener(m.TargetStatus,({detail:{status:e}})=>{y({target_status_shown:e==="shown"})});document.addEventListener(m.Chrono,({detail:{elapsed:e}})=>{const t=document.getElementById("chrono");t&&(t.textContent=`${Math.floor(e/1e3)}s`)});document.addEventListener(m.ProgramAdded,({detail:{program_id:e}})=>{C()});document.addEventListener(m.ProgramDeleted,({detail:{program_id:e}})=>{C()});async function B(){try{const e=document.getElementById("programs-container"),t=await P();if(e.innerHTML="",t.length>0){const a=document.createElement("ul");t.slice().sort((o,n)=>o.id-n.id).forEach(o=>{const n=document.createElement("li"),r=document.createElement("span");if(r.textContent=`${o.id}: ${o.title}`,n.appendChild(r),!o.readonly){const d=document.createElement("button");d.textContent="Delete",d.classList.add("delete-btn"),d.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${o.title}"?`))try{await k(o.id),alert(`Program "${o.title}" deleted successfully.`),await B()}catch(i){console.error("Failed to delete program:",i),alert("Failed to delete program.")}}),n.appendChild(d)}const s=document.createElement("button");s.textContent="JSON",s.classList.add("show-json-btn"),s.addEventListener("click",()=>{const d=JSON.stringify(o,null,2),i=new Blob([d],{type:"application/json"}),c=URL.createObjectURL(i);window.open(c,"_blank")}),n.appendChild(s),a.appendChild(n)}),e.appendChild(a)}}catch(e){console.error("Error loading programs:",e)}}async function se(){const e=document.getElementById("program-file"),t=document.getElementById("program-upload-form"),a=document.getElementById("upload-programs-timeline-wrapper"),o=document.getElementById("upload-programs-timeline");e.addEventListener("change",n=>{const r=n.target.files[0];if(!r)return;const s=new FileReader;s.onload=d=>{const i=JSON.parse(d.target.result);R(o,i),a.classList.remove("hidden")},s.readAsText(r)}),t.addEventListener("submit",async n=>{n.preventDefault();const r=e.files[0];if(!r){alert("Please select a program file.");return}const s=new FileReader;s.onload=async d=>{try{const i=JSON.parse(d.target.result);await j(i),alert("Program uploaded successfully!")}catch(i){alert("Failed to upload program: "+i.message)}},s.readAsText(r)}),await B()}document.addEventListener(m.ProgramAdded,async({detail:{id:e}})=>{await B(),console.log("Program added:",e)});document.addEventListener(m.ProgramDeleted,async({detail:{id:e}})=>{await B(),console.log("Program deleted:",e)});document.addEventListener("DOMContentLoaded",async()=>{const a="MalmÃ¶ Skyttegille Rotation Target v0.4.1";document.title=a,document.querySelector("#footer span").textContent=a,await C();const o=document.getElementById("run-tab-button"),n=document.getElementById("audio-tab-button"),r=document.getElementById("programs-tab-button"),s=document.getElementById("settings-tab-button"),d=document.getElementById("run-section"),i=document.getElementById("audio-section"),c=document.getElementById("programs-section"),l=document.getElementById("settings-section");o.addEventListener("click",async()=>{o.classList.add("active"),n.classList.remove("active"),r.classList.remove("active"),s.classList.remove("active"),d.classList.remove("hidden"),i.classList.add("hidden"),c.classList.add("hidden"),l.classList.add("hidden"),await C()}),n.addEventListener("click",async()=>{n.classList.add("active"),o.classList.remove("active"),r.classList.remove("active"),s.classList.remove("active"),i.classList.remove("hidden"),d.classList.add("hidden"),c.classList.add("hidden"),l.classList.add("hidden"),await te()}),r.addEventListener("click",()=>{r.classList.add("active"),o.classList.remove("active"),n.classList.remove("active"),s.classList.remove("active"),c.classList.remove("hidden"),d.classList.add("hidden"),i.classList.add("hidden"),l.classList.add("hidden"),se()}),s.addEventListener("click",()=>{s.classList.add("active"),o.classList.remove("active"),n.classList.remove("active"),r.classList.remove("active"),l.classList.remove("hidden"),d.classList.add("hidden"),i.classList.add("hidden"),c.classList.add("hidden"),$()}),A((g,h)=>{console.log("SSE Event:",g,h);const v=new CustomEvent(g,{detail:h});document.dispatchEvent(v)})});
