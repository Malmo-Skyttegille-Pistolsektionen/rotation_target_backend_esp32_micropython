(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function s(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(n){if(n.ep)return;n.ep=!0;const a=s(n);fetch(n.href,a)}})();const A=()=>localStorage.getItem("SERVER_BASE_URL")||"http://localhost:8080";let y=A(),g=`${y}/api/v1`,I=`${y}/sse/v1`;function R(e){y=e,g=`${y}/api/v1`,I=`${y}/sse/v1`,localStorage.setItem("SERVER_BASE_URL",e)}function O(){const e=document.getElementById("settings-form"),t=document.getElementById("server-base-url"),s=document.getElementById("settings-status");t.value=y,e.onsubmit=o=>{o.preventDefault();const n=t.value.trim();if(!n||!N(n)){s.textContent="Please enter a valid URL.",s.style.color="red";return}R(n),s.textContent="Server Base URL updated!",s.style.color="green"}}function N(e){try{const t=new URL(e);return/^https?:$/.test(t.protocol)&&(/^[a-zA-Z0-9.-]+$/.test(t.hostname)||/^(\d{1,3}\.){3}\d{1,3}$/.test(t.hostname))?/^(\d{1,3}\.){3}\d{1,3}$/.test(t.hostname)?t.hostname.split(".").every(s=>{const o=Number(s);return o>=0&&o<=255}):!0:!1}catch{return!1}}async function T(){const e=await fetch(`${g}/programs`);return f(e)}async function D(e){const t=await fetch(`${g}/programs/${e}`);return f(t)}async function F(e){const t=await fetch(`${g}/programs`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});return f(t)}async function U(e){const t=await fetch(`${g}/programs/${e}/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"}});return f(t)}async function j(e){const t=await fetch(`${g}/programs/${e}/load`,{method:"POST"});return f(t)}async function M(){const e=await fetch(`${g}/programs/start`,{method:"POST"});return f(e)}async function q(){const e=await fetch(`${g}/programs/stop`,{method:"POST"});return f(e)}async function k(e){const t=await fetch(`${g}/programs/series/${e}/skip_to`,{method:"POST",headers:{"Content-Type":"application/json"}});return f(t)}async function V(){const e=await fetch(`${g}/audios`);return f(e)}async function z(e,t,s){const o=new FormData;o.append("file",e),o.append("codec",t),o.append("title",s);const n=await fetch(`${g}/audios`,{method:"POST",body:o});return f(n)}async function J(e){const t=await fetch(`${g}/audios/${e}/delete`,{method:"DELETE",headers:{"Content-Type":"application/json"}});return f(t)}async function H(){const e=await fetch(`${g}/targets/toggle`,{method:"POST"});return f(e)}async function f(e){if(console.log("Response status:",e.status,e.statusText),!e.ok)throw new Error("Request failed: ${response.statusText}");const t=e.headers.get("Content-Type");return t&&t.includes("application/json")?e.json():null}const m={ProgramAdded:"program_added",ProgramDeleted:"program_deleted",ProgramStarted:"program_started",ProgramCompleted:"program_completed",SeriesStarted:"series_started",SeriesCompleted:"series_completed",SeriesStopped:"series_stopped",SeriesNext:"series_next",EventStarted:"event_started",TargetStatus:"target_status",AudioAdded:"audio_added",AudioDeleted:"audio_deleted",Chrono:"chrono"};function W(e){const t=new EventSource(`${I}`,{withCredentials:!1});return Object.values(m).forEach(s=>{t.addEventListener(s,o=>{try{const n=JSON.parse(o.data);console.log("Received SSE event:",s,n),e(s,n)}catch(n){console.error("Failed to parse event:",s,n)}})}),t.onopen=()=>{console.log("SSE connection established")},t.onerror=s=>{console.error("SSE connection error:",s)},t}let K=[];function Z(e){const t=K.find(s=>s.id===e);return t?t.title:`Audio ${e}`}async function L(){try{const e=document.getElementById("audio-container"),{audios:t=[]}=await V();if(e.innerHTML="",t.length>0){const s=document.createElement("ul");t.slice().sort((o,n)=>o.id-n.id).forEach(o=>{const n=document.createElement("li");if(n.textContent=`${o.id}: ${o.title}`,!o.readonly){const a=document.createElement("button");a.textContent="Delete",a.classList.add("delete-btn"),a.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${o.title}"?`))try{await J(o.id),alert(`Audio "${o.title}" deleted successfully.`),await L()}catch(r){console.error("Failed to delete audio:",r),alert("Failed to delete audio.")}}),n.appendChild(a)}s.appendChild(n)}),e.appendChild(s)}}catch(e){console.error("Error loading audios:",e)}}async function G(){const e=document.getElementById("audio-file"),t=document.getElementById("audio-title");e.addEventListener("change",()=>{const o=e.files[0];if(o){const n=o.name.lastIndexOf("."),a=n>0?o.name.substring(0,n):o.name;t.value=a}});const s=document.getElementById("audio-form");document.getElementById("audio-container"),s.addEventListener("submit",async o=>{o.preventDefault();const n=document.getElementById("audio-file").files[0],a=document.getElementById("audio-title").value,r=document.getElementById("audio-codec").value;if(console.debug("Form submit:",{file:n,title:a,codec:r}),!n||!a||!r){console.debug("Missing required fields",{file:n,title:a,codec:r});return}try{await z(n,r,a),console.debug("Upload successful"),s.reset(),await L()}catch(d){console.error("Upload failed:",d),alert("Upload failed")}}),await L()}document.addEventListener(m.AudioAdded,async({detail:{id:e}})=>{L(),console.log("Audio added:",e)});document.addEventListener(m.AudioDeleted,async({detail:{id:e}})=>{L(),console.log("Audio deleted:",e)});let C=null;function P(e,t){e.innerHTML="",C=Q(t.series),C.forEach((s,o)=>{const n=document.createElement("div");n.className="series",s.optional&&n.classList.add("optional"),n.dataset.seriesIndex=o;const a=document.createElement("div");a.textContent=s.name+(s.optional?" (optional)":""),n.appendChild(a);const r=document.createElement("div");r.className="events",s.events.forEach((d,c)=>{const l=document.createElement("div");l.className=`event ${d.symbolClass}`,l.dataset.eventIndex=c;const i=document.createElement("div");i.className="dur",i.textContent=Math.trunc(d.duration/1e3),l.appendChild(i);const u=document.createElement("div");u.className="symbol",u.textContent=d.symbolText,l.appendChild(u);const p=document.createElement("div");if(p.className="acc",p.textContent=Math.trunc(d.acc/1e3),l.appendChild(p),d.audio_ids&&d.audio_ids.length>0){const h=d.audio_ids.map(Z).join(", ");l.setAttribute("title",h)}r.appendChild(l)}),n.appendChild(r),e.appendChild(n)})}function Q(e){return e.map(t=>{let s=0;const o=t.events.map(n=>{const a=n.duration;let r="no-action",d="";n.command==="show"&&n.audio_ids?(r="show audio",d="A"):n.command==="hide"&&n.audio_ids?(r="hide audio",d="A"):n.command==="show"?r="show":n.command==="hide"?r="hide":n.audio_ids&&(r="audio",d="A");const c={...n,duration:a,acc:s,symbolClass:r,symbolText:d};return s+=a,c});return{...t,events:o}})}function S(e,t){document.querySelectorAll(".series").forEach(o=>o.classList.remove("current")),document.querySelectorAll(".event").forEach(o=>o.classList.remove("current"));const s=document.querySelector(`[data-series-index='${e}']`);if(s){s.classList.add("current");const o=s.querySelector(`[data-event-index='${t}']`);o&&o.classList.add("current")}}function X(){document.querySelectorAll(".series").forEach(e=>e.classList.remove("current")),document.querySelectorAll(".event").forEach(e=>e.classList.remove("current"))}const $={program_id:null,running_series_start:null,current_series_index:null,current_event_index:null,target_status_shown:!1};function E(e){Object.assign($,e)}function v(){const e=document.getElementById("start-btn"),t=document.getElementById("stop-btn"),{program_id:s,running_series_start:o}=$;s!==null&&o===null?(e.classList.remove("hidden"),t.classList.add("hidden")):o!==null?(e.classList.add("hidden"),t.classList.remove("hidden")):(e.classList.add("hidden"),t.classList.add("hidden"))}async function w(){const e=document.getElementById("choose-program"),t=document.getElementById("choose-serie"),s=document.getElementById("show-json"),o=document.getElementById("run-timeline-wrapper"),n=document.getElementById("run-program-timeline"),a=document.getElementById("start-btn"),r=document.getElementById("stop-btn"),d=document.getElementById("toggle-btn");document.getElementById("chrono");try{const c=await T();console.log("Fetched programs:",c),e.innerHTML="";const l=document.createElement("option");l.disabled=!0,l.selected=!0,l.textContent="Choose program",e.appendChild(l),c.forEach(i=>{const u=document.createElement("option");u.value=i.id,u.textContent=i.title,e.appendChild(u)}),e.addEventListener("change",async()=>{const i=parseInt(e.value,10);if(!isNaN(i)){const u=e.querySelector("option[disabled]");u&&u.remove(),await j(i);try{const p=await D(i);window.currentProgram=p,P(n,p),S(0,0),E({program_id:i,running_series_start:null}),v(),t.innerHTML="";const h=document.createElement("option");h.disabled=!0,h.selected=!0,h.textContent="Choose a series",t.appendChild(h),p.series.forEach((B,x)=>{const b=document.createElement("option");b.value=x,b.textContent=B.name+(B.optional?" (optional)":""),t.appendChild(b)}),t.classList.remove("hidden"),s.classList.remove("hidden"),o.classList.remove("hidden"),a.disabled=!1,r.disabled=!1}catch(p){console.error("Failed to fetch program by ID:",p)}}}),t.addEventListener("change",async()=>{const i=parseInt(t.value,10);isNaN(i)||k(i)}),s.addEventListener("click",()=>{if(window.currentProgram){const i=JSON.stringify(window.currentProgram,null,2),u=new Blob([i],{type:"application/json"}),p=URL.createObjectURL(u);window.open(p,"_blank")}}),a.addEventListener("click",async()=>{await M()}),r.addEventListener("click",async()=>{await q()}),d.addEventListener("click",async()=>{await H()})}catch(c){console.error("Failed to initialize Run tab:",c)}}document.addEventListener(m.ProgramCompleted,({detail:{program_id:e}})=>{E({program_id:null,running_series_start:null}),X(),v()});document.addEventListener(m.SeriesStarted,({detail:{program_id:e,series_index:t}})=>{E({program_id:e,running_series_start:new Date,current_series_index:t,current_event_index:0}),S(t,0),document.getElementById("chrono").classList.remove("hidden"),v()});document.addEventListener(m.SeriesCompleted,({detail:{program_id:e}})=>{E({running_series_start:null}),document.getElementById("chrono").classList.add("hidden"),v()});document.addEventListener(m.SeriesStopped,({detail:{program_id:e,series_index:t,event_index:s}})=>{E({program_id:e,running_series_start:null,current_series_index:t,current_event_index:s}),S(t,s),document.getElementById("chrono").classList.add("hidden"),v()});document.addEventListener(m.SeriesNext,({detail:{program_id:e,series_index:t}})=>{E({program_id:e,current_series_index:t,current_event_index:0}),S(t,0),v()});document.addEventListener(m.EventStarted,({detail:{program_id:e,series_index:t,event_index:s}})=>{E({program_id:e,current_series_index:t,current_event_index:s}),S(t,s)});document.addEventListener(m.TargetStatus,({detail:{status:e}})=>{E({target_status_shown:e==="shown"})});document.addEventListener(m.Chrono,({detail:{elapsed:e}})=>{const t=document.getElementById("chrono");t&&(t.textContent=`${Math.floor(e/1e3)}s`)});document.addEventListener(m.ProgramAdded,({detail:{program_id:e}})=>{w()});document.addEventListener(m.ProgramDeleted,({detail:{program_id:e}})=>{w()});async function _(){try{const e=document.getElementById("programs-container"),t=await T();if(e.innerHTML="",t.length>0){const s=document.createElement("ul");t.slice().sort((o,n)=>o.id-n.id).forEach(o=>{const n=document.createElement("li");if(n.textContent=`${o.id}: ${o.title}`,!o.readonly){const a=document.createElement("button");a.textContent="Delete",a.classList.add("delete-btn"),a.addEventListener("click",async()=>{if(confirm(`Are you sure you want to delete "${o.title}"?`))try{await U(o.id),alert(`Program "${o.title}" deleted successfully.`),await _()}catch(r){console.error("Failed to delete program:",r),alert("Failed to delete program.")}}),n.appendChild(a)}s.appendChild(n)}),e.appendChild(s)}}catch(e){console.error("Error loading programs:",e)}}async function Y(){const e=document.getElementById("program-file"),t=document.getElementById("program-upload-form"),s=document.getElementById("upload-programs-timeline-wrapper"),o=document.getElementById("upload-programs-timeline");e.addEventListener("change",n=>{const a=n.target.files[0];if(!a)return;const r=new FileReader;r.onload=d=>{const c=JSON.parse(d.target.result);P(o,c),s.classList.remove("hidden")},r.readAsText(a)}),t.addEventListener("submit",async n=>{n.preventDefault();const a=e.files[0];if(!a){alert("Please select a program file.");return}const r=new FileReader;r.onload=async d=>{try{const c=JSON.parse(d.target.result);await F(c),alert("Program uploaded successfully!")}catch(c){alert("Failed to upload program: "+c.message)}},r.readAsText(a)}),await _()}document.addEventListener(m.ProgramAdded,async({detail:{id:e}})=>{await _(),console.log("Program added:",e)});document.addEventListener(m.ProgramDeleted,async({detail:{id:e}})=>{await _(),console.log("Program deleted:",e)});document.addEventListener("DOMContentLoaded",async()=>{const s="MalmÃ¶ Skyttegille Rotation Target v0.4.1";document.title=s,document.querySelector("#footer span").textContent=s,await w();const o=document.getElementById("run-tab-button"),n=document.getElementById("audio-tab-button"),a=document.getElementById("programs-tab-button"),r=document.getElementById("settings-tab-button"),d=document.getElementById("run-section"),c=document.getElementById("audio-section"),l=document.getElementById("programs-section"),i=document.getElementById("settings-section");o.addEventListener("click",async()=>{o.classList.add("active"),n.classList.remove("active"),a.classList.remove("active"),r.classList.remove("active"),d.classList.remove("hidden"),c.classList.add("hidden"),l.classList.add("hidden"),i.classList.add("hidden"),await w()}),n.addEventListener("click",async()=>{n.classList.add("active"),o.classList.remove("active"),a.classList.remove("active"),r.classList.remove("active"),c.classList.remove("hidden"),d.classList.add("hidden"),l.classList.add("hidden"),i.classList.add("hidden"),await G()}),a.addEventListener("click",()=>{a.classList.add("active"),o.classList.remove("active"),n.classList.remove("active"),r.classList.remove("active"),l.classList.remove("hidden"),d.classList.add("hidden"),c.classList.add("hidden"),i.classList.add("hidden"),Y()}),r.addEventListener("click",()=>{r.classList.add("active"),o.classList.remove("active"),n.classList.remove("active"),a.classList.remove("active"),i.classList.remove("hidden"),d.classList.add("hidden"),c.classList.add("hidden"),l.classList.add("hidden"),O()}),W((u,p)=>{console.log("SSE Event:",u,p);const h=new CustomEvent(u,{detail:p});document.dispatchEvent(h)})});
