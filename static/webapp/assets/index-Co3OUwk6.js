(function () { const t = document.createElement("link").relList; if (t && t.supports && t.supports("modulepreload")) return; for (const n of document.querySelectorAll('link[rel="modulepreload"]')) r(n); new MutationObserver(n => { for (const a of n) if (a.type === "childList") for (const s of a.addedNodes) s.tagName === "LINK" && s.rel === "modulepreload" && r(s) }).observe(document, { childList: !0, subtree: !0 }); function o(n) { const a = {}; return n.integrity && (a.integrity = n.integrity), n.referrerPolicy && (a.referrerPolicy = n.referrerPolicy), n.crossOrigin === "use-credentials" ? a.credentials = "include" : n.crossOrigin === "anonymous" ? a.credentials = "omit" : a.credentials = "same-origin", a } function r(n) { if (n.ep) return; n.ep = !0; const a = o(n); fetch(n.href, a) } })(); let _ = null; function w(e, t) { e.innerHTML = "", _ = I(t.series), _.forEach((o, r) => { const n = document.createElement("div"); n.className = "series", o.optional && n.classList.add("optional"), n.dataset.seriesIndex = r; const a = document.createElement("div"); a.textContent = o.name + (o.optional ? " (optional)" : ""), n.appendChild(a); const s = document.createElement("div"); s.className = "events", o.events.forEach((d, l) => { const i = document.createElement("div"); i.className = `event ${d.symbolClass}`, i.dataset.eventIndex = l; const c = document.createElement("div"); c.className = "dur", c.textContent = d.duration, i.appendChild(c); const u = document.createElement("div"); u.className = "symbol", u.textContent = d.symbolText, i.appendChild(u); const g = document.createElement("div"); g.className = "acc", g.textContent = d.acc, i.appendChild(g), s.appendChild(i) }), n.appendChild(s), e.appendChild(n) }) } function I(e) { return e.map(t => { let o = 0; const r = t.events.map(n => { const a = n.duration; let s = "no-action", d = ""; n.command === "show" && n.audio_ids ? (s = "show audio", d = "A") : n.command === "hide" && n.audio_ids ? (s = "hide audio", d = "A") : n.command === "show" ? s = "show" : n.command === "hide" ? s = "hide" : n.audio_ids && (s = "audio", d = "A"); const l = { ...n, duration: a, acc: o, symbolClass: s, symbolText: d }; return o += a, l }); return { ...t, events: r } }) } function y(e, t) { document.querySelectorAll(".series").forEach(r => r.classList.remove("current")), document.querySelectorAll(".event").forEach(r => r.classList.remove("current")); const o = document.querySelector(`[data-series-index='${e}']`); if (o) { o.classList.add("current"); const r = o.querySelector(`[data-event-index='${t}']`); r && r.classList.add("current") } } function T() { document.querySelectorAll(".series").forEach(e => e.classList.remove("current")), document.querySelectorAll(".event").forEach(e => e.classList.remove("current")) } const C = "http://192.168.1.71:8080", p = `${C}/api/v1`, x = `${C}/sse/v1`; async function P() { const e = await fetch(`${p}/programs`); return h(e) } async function $(e) { const t = await fetch(`${p}/programs/${e}`); return h(t) } async function A(e) { const t = await fetch(`${p}/programs/${e}/load`, { method: "POST" }); return h(t) } async function O() { const e = await fetch(`${p}/programs/start`, { method: "POST" }); return h(e) } async function N() { const e = await fetch(`${p}/programs/stop`, { method: "POST" }); return h(e) } async function R(e) { const t = await fetch(`${p}/programs/series/${e}/skip_to`, { method: "POST", headers: { "Content-Type": "application/json" } }); return h(t) } async function D() { const e = await fetch(`${p}/audios`); return h(e) } async function F({ file: e, codec: t, title: o }) { const r = new FormData; r.append("file", e), r.append("codec", t), r.append("title", o); const n = await fetch(`${p}/audios/upload`, { method: "POST", body: r }); return h(n) } async function U(e) { const t = await fetch(`${p}/audios/${e}/delete`, { method: "DELETE", headers: { "Content-Type": "application/json" } }); return h(t) } async function h(e) { if (console.log("Response status:", e.status, e.statusText), !e.ok) throw new Error("Request failed: ${response.statusText}"); const t = e.headers.get("Content-Type"); return t && t.includes("application/json") ? e.json() : null } const m = { ProgramUploaded: "program_uploaded", ProgramStarted: "program_started", ProgramCompleted: "program_completed", SeriesStarted: "series_started", SeriesCompleted: "series_completed", SeriesStopped: "series_stopped", SeriesNext: "series_next", EventStarted: "event_started", TargetStatus: "target_status", AudioAdded: "audio_added", AudioDeleted: "audio_deleted", Chrono: "chrono" }; function q(e) { const t = new EventSource(`${x}`, { withCredentials: !1 }); return Object.values(m).forEach(o => { t.addEventListener(o, r => { try { const n = JSON.parse(r.data); console.log("Received SSE event:", o, n), e(o, n) } catch (n) { console.error("Failed to parse event:", o, n) } }) }), t.onopen = () => { console.log("SSE connection established") }, t.onerror = o => { console.error("SSE connection error:", o) }, t } const b = { program_id: null, running_series_start: null, current_series_index: null, current_event_index: null, target_status_shown: !1 }; function f(e) { Object.assign(b, e) } function E() { const e = document.getElementById("start-btn"), t = document.getElementById("stop-btn"), { program_id: o, running_series_start: r } = b; o !== null && r === null ? (e.classList.remove("hidden"), t.classList.add("hidden")) : r !== null ? (e.classList.add("hidden"), t.classList.remove("hidden")) : (e.classList.add("hidden"), t.classList.add("hidden")) } async function j() { const e = document.getElementById("choose-program"), t = document.getElementById("choose-serie"), o = document.getElementById("show-json"), r = document.getElementById("programs-timeline-wrapper"), n = document.getElementById("programs-timeline"), a = document.getElementById("start-btn"), s = document.getElementById("stop-btn"); document.getElementById("chrono"); try { const d = await P(); console.log("Fetched programs:", d), e.innerHTML = ""; const l = document.createElement("option"); l.disabled = !0, l.selected = !0, l.textContent = "Choose program", e.appendChild(l), d.forEach(i => { const c = document.createElement("option"); c.value = i.id, c.textContent = i.title, e.appendChild(c) }), e.addEventListener("change", async () => { const i = parseInt(e.value, 10); if (!isNaN(i)) { const c = e.querySelector("option[disabled]"); c && c.remove(), await A(i); try { const u = await $(i); window.currentProgram = u, w(n, u), y(0, 0), f({ program_id: i, running_series_start: null }), E(), t.innerHTML = ""; const g = document.createElement("option"); g.disabled = !0, g.selected = !0, g.textContent = "Choose a series", t.appendChild(g), u.series.forEach((S, B) => { const L = document.createElement("option"); L.value = B, L.textContent = S.name + (S.optional ? " (optional)" : ""), t.appendChild(L) }), t.classList.remove("hidden"), o.classList.remove("hidden"), r.classList.remove("hidden"), a.disabled = !1, s.disabled = !1 } catch (u) { console.error("Failed to fetch program by ID:", u) } } }), t.addEventListener("change", async () => { const i = parseInt(t.value, 10); isNaN(i) || R(i) }), o.addEventListener("click", () => { if (window.currentProgram) { const i = JSON.stringify(window.currentProgram, null, 2), c = new Blob([i], { type: "application/json" }), u = URL.createObjectURL(c); window.open(u, "_blank") } }), a.addEventListener("click", async () => { await O() }), s.addEventListener("click", async () => { await N() }) } catch (d) { console.error("Failed to initialize Programs tab:", d) } } document.addEventListener(m.ProgramCompleted, ({ detail: { program_id: e } }) => { f({ program_id: null, running_series_start: null }), T(), E() }); document.addEventListener(m.SeriesStarted, ({ detail: { program_id: e, series_index: t } }) => { f({ program_id: e, running_series_start: new Date, current_series_index: t, current_event_index: 0 }), y(t, 0), document.getElementById("chrono").classList.remove("hidden"), E() }); document.addEventListener(m.SeriesCompleted, ({ detail: { program_id: e } }) => { f({ running_series_start: null }), document.getElementById("chrono").classList.add("hidden"), E() }); document.addEventListener(m.SeriesStopped, ({ detail: { program_id: e, series_index: t, event_index: o } }) => { f({ program_id: e, running_series_start: null, current_series_index: t, current_event_index: o }), y(t, o), document.getElementById("chrono").classList.add("hidden"), E() }); document.addEventListener(m.SeriesNext, ({ detail: { program_id: e, series_index: t } }) => { f({ program_id: e, current_series_index: t, current_event_index: 0 }), y(t, 0), E() }); document.addEventListener(m.EventStarted, ({ detail: { program_id: e, series_index: t, event_index: o } }) => { f({ program_id: e, current_series_index: t, current_event_index: o }), y(t, o) }); document.addEventListener(m.TargetStatus, ({ detail: { status: e } }) => { f({ target_status_shown: e === "shown" }) }); document.addEventListener(m.Chrono, ({ detail: { elapsed: e } }) => { const t = document.getElementById("chrono"); t && (t.textContent = `${Math.floor(e / 1e3)}s`) }); async function v() { try { const e = document.getElementById("audio-container"), { builtin: t = [], uploaded: o = [] } = await D(); if (e.innerHTML = "", t.length > 0) { const r = document.createElement("h3"); r.textContent = "Built-in:", e.appendChild(r); const n = document.createElement("ul"); t.forEach(a => { const s = document.createElement("li"); s.textContent = `${a.id}: ${a.title}`, n.appendChild(s) }), e.appendChild(n) } if (o.length > 0) { const r = document.createElement("h3"); r.textContent = "Uploaded:", e.appendChild(r); const n = document.createElement("ul"); o.forEach(a => { const s = document.createElement("li"); s.textContent = `${a.id}: ${a.title}`; const d = document.createElement("button"); d.textContent = "Delete", d.classList.add("delete-btn"), d.addEventListener("click", async () => { if (confirm(`Are you sure you want to delete "${a.title}"?`)) try { await U(a.id), alert(`Audio "${a.title}" deleted successfully.`), await v() } catch (l) { console.error("Failed to delete audio:", l), alert("Failed to delete audio.") } }), s.appendChild(d), n.appendChild(s) }), e.appendChild(n) } } catch (e) { console.error("Error loading audios:", e) } } async function M() { const e = document.getElementById("audio-form"); document.getElementById("audio-container"), e.addEventListener("submit", async t => { t.preventDefault(); const o = document.getElementById("audio-file").files[0], r = document.getElementById("audio-title").value, n = document.getElementById("audio-codec").value; if (!o || !r || !n) return; const a = new FormData; a.append("file", o), a.append("title", r), a.append("codec", n); try { await F(o, n, r), e.reset(), await v() } catch (s) { console.error("Upload failed:", s), alert("Upload failed") } }), await v() } document.addEventListener(m.AudioUploaded, ({ detail: { id: e } }) => { v(), console.log("Audio uploaded:", e) }); document.addEventListener(m.AudioDeleted, ({ detail: { id: e } }) => { v(), console.log("Audio deleted:", e) }); function k() { const e = document.getElementById("program-file"), t = document.getElementById("upload-programs-timeline-wrapper"), o = document.getElementById("upload-programs-timeline"); e.addEventListener("change", r => { const n = r.target.files[0]; if (!n) return; const a = new FileReader; a.onload = s => { const d = JSON.parse(s.target.result); w(o, d), t.classList.remove("hidden") }, a.readAsText(n) }) } document.addEventListener("DOMContentLoaded", async () => { const o = "MalmÃ¶ Skyttegille Rotation Target v0.4.1"; document.title = o, document.querySelector("#footer span").textContent = o, await j(); const r = document.getElementById("program-tab-button"), n = document.getElementById("audio-tab-button"), a = document.getElementById("upload-program-tab-button"), s = document.getElementById("program-section"), d = document.getElementById("audio-section"), l = document.getElementById("upload-program-section"); r.addEventListener("click", () => { r.classList.add("active"), n.classList.remove("active"), a.classList.remove("active"), s.classList.remove("hidden"), d.classList.add("hidden"), l.classList.add("hidden") }), n.addEventListener("click", async () => { n.classList.add("active"), r.classList.remove("active"), a.classList.remove("active"), d.classList.remove("hidden"), s.classList.add("hidden"), l.classList.add("hidden"), await M() }), a.addEventListener("click", () => { a.classList.add("active"), r.classList.remove("active"), n.classList.remove("active"), l.classList.remove("hidden"), s.classList.add("hidden"), d.classList.add("hidden"), k() }), q((i, c) => { console.log("SSE Event:", i, c); const u = new CustomEvent(i, { detail: c }); document.dispatchEvent(u) }) });
